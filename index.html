<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ— äººæœºé£è¡Œæ•°æ®åˆ†æå·¥å…· - å¤šåŠŸèƒ½ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 10px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 97vh;
        }
        
        header {
            background: linear-gradient(90deg, #3498db, #2980b9);
            color: white;
            padding: 15px;
            text-align: center;
            flex-shrink: 0;
        }
        
        h1 {
            font-size: 22px;
            margin-bottom: 8px;
        }
        
        .description {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            min-height: 0;
            overflow: hidden;
            flex-direction: column;
        }
        
        .file-list {
            background: #2c3e50;
            color: white;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
            flex-shrink: 0;
            max-height: 200px;
        }
        
        .file-list h2 {
            margin-bottom: 12px;
            font-size: 18px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            text-align: center;
        }
        
        .file-item {
            padding: 10px 12px;
            margin: 6px 0;
            background: #34495e;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .file-item:hover {
            background: #3498db;
            transform: translateX(3px);
        }
        
        .file-item.active {
            background: #3498db;
            font-weight: bold;
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.5);
        }
        
        .file-upload {
            margin-top: 15px;
            padding: 12px;
            background: #34495e;
            border-radius: 6px;
            text-align: center;
        }
        
        .file-upload-btn {
            display: inline-block;
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 14px;
        }
        
        .file-upload-btn:hover {
            background: #2980b9;
        }
        
        #file-input {
            display: none;
        }
        
        .amap-link {
            color: #2c3e50;
            text-decoration: none;
            cursor: pointer;
            display: block;
        }

        .amap-link:hover {
            color: #3498db;
            text-decoration: underline;
        }
        
        .double-click-hint {
            position: absolute;
            bottom: 70px;
            left: 0;
            right: 0;
            text-align: center;
            color: #7f8c8d;
            font-size: 12px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin: 0 10px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .content-area {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: visible;
            min-height: 0;
        }
        
        .info-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #3498db;
            flex-shrink: 0;
        }
        
        .info-box h3 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 16px;
            text-align: center;
        }
        
        .data-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .data-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .data-item label {
            display: block;
            color: #7f8c8d;
            font-size: 12px;
            margin-bottom: 6px;
        }
        
        .data-item .value {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .table-container {
            flex: 1;
            overflow: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            min-height: 400px;
            -webkit-overflow-scrolling: touch;
            /* ä¿®å¤stickyè¡¨å¤´é—®é¢˜ */
            max-height: calc(100vh - 300px);
            /* ç¡®ä¿æ¨ªå‘æ»šåŠ¨æ¡æ­£ç¡®æ˜¾ç¤º */
            overflow-x: auto;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 100%;
            /* ä½¿ç”¨autoå¸ƒå±€å®ç°çœŸæ­£çš„è‡ªé€‚åº”å®½åº¦ */
            table-layout: auto;
        }
        
        thead {
            position: sticky;
            top: 0;
            z-index: 10;
            /* ç¡®ä¿è¡¨å¤´åœ¨æ»šåŠ¨æ—¶ä¿æŒå¯è§ */
            background: #3498db;
        }
        
        th {
            background: #3498db;
            color: black;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            white-space: nowrap;
            font-size: 14px;
            /* è¡¨å¤´å•å…ƒæ ¼æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ */
            min-width: auto;
            max-width: none;
        }
        
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
            white-space: nowrap;
            font-size: 13px;
            /* æ•°æ®å•å…ƒæ ¼æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ */
            min-width: auto;
            max-width: none;
        }
        
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        tr:hover {
            background: #e3f2fd;
        }
        
        /* è¡¨å¤´åˆ—é¢œè‰² */
        .col-time { background-color: #e1bee7; }
        .col-distance { background-color: #ffebee; }
        .col-height { background-color: #e8f5e9; }
        .col-longitude { background-color: #e3f2fd; }
        .col-latitude { background-color: #fff8e1; }
        .col-speed { background-color: #f3e5f5; }
        .col-vertical-speed { background-color: #e0f2f1; }
        .col-satellites { background-color: #fff3e0; }
        .col-direction { background-color: #e8eaf6; }
        .col-angle { background-color: #f1f8e9; }
        .col-battery { background-color: #ffecb3; }
        .col-flight-time { background-color: #ffcdd2; }
        
        /* æ•°æ®åˆ—é¢œè‰² - æ¯”è¡¨å¤´ç•¥æµ… */
        td.col-time { background-color: rgba(225, 190, 231, 0.3); }
        td.col-distance { background-color: rgba(255, 235, 238, 0.3); }
        td.col-height { background-color: rgba(232, 245, 233, 0.3); }
        td.col-longitude { background-color: rgba(227, 242, 253, 0.3); }
        td.col-latitude { background-color: rgba(255, 248, 225, 0.3); }
        td.col-speed { background-color: rgba(243, 229, 245, 0.3); }
        td.col-vertical-speed { background-color: rgba(224, 242, 241, 0.3); }
        td.col-satellites { background-color: rgba(255, 243, 224, 0.3); }
        td.col-direction { background-color: rgba(232, 234, 246, 0.3); }
        td.col-angle { background-color: rgba(241, 248, 233, 0.3); }
        td.col-battery { background-color: rgba(255, 236, 179, 0.3); }
        td.col-flight-time { background-color: rgba(255, 205, 210, 0.3); }
        
        /* å¶æ•°è¡Œæ•°æ®åˆ—é¢œè‰²ç•¥æ·± */
        tr:nth-child(even) td.col-time { background-color: rgba(225, 190, 231, 0.5); }
        tr:nth-child(even) td.col-distance { background-color: rgba(255, 235, 238, 0.5); }
        tr:nth-child(even) td.col-height { background-color: rgba(232, 245, 233, 0.5); }
        tr:nth-child(even) td.col-longitude { background-color: rgba(227, 242, 253, 0.5); }
        tr:nth-child(even) td.col-latitude { background-color: rgba(255, 248, 225, 0.5); }
        tr:nth-child(even) td.col-speed { background-color: rgba(243, 229, 245, 0.5); }
        tr:nth-child(even) td.col-vertical-speed { background-color: rgba(224, 242, 241, 0.5); }
        tr:nth-child(even) td.col-satellites { background-color: rgba(255, 243, 224, 0.5); }
        tr:nth-child(even) td.col-direction { background-color: rgba(232, 234, 246, 0.5); }
        tr:nth-child(even) td.col-angle { background-color: rgba(241, 248, 233, 0.5); }
        tr:nth-child(even) td.col-battery { background-color: rgba(255, 236, 179, 0.5); }
        tr:nth-child(even) td.col-flight-time { background-color: rgba(255, 205, 210, 0.5); }
        
        /* é¼ æ ‡æ‚¬åœæ—¶çš„é¢œè‰² */
        tr:hover td.col-time { background-color: rgba(225, 190, 231, 0.7); }
        tr:hover td.col-distance { background-color: rgba(255, 235, 238, 0.7); }
        tr:hover td.col-height { background-color: rgba(232, 245, 233, 0.7); }
        tr:hover td.col-longitude { background-color: rgba(227, 242, 253, 0.7); }
        tr:hover td.col-latitude { background-color: rgba(255, 248, 225, 0.7); }
        tr:hover td.col-speed { background-color: rgba(243, 229, 245, 0.7); }
        tr:hover td.col-vertical-speed { background-color: rgba(224, 242, 241, 0.7); }
        tr:hover td.col-satellites { background-color: rgba(255, 243, 224, 0.7); }
        tr:hover td.col-direction { background-color: rgba(232, 234, 246, 0.7); }
        tr:hover td.col-angle { background-color: rgba(241, 248, 233, 0.7); }
        tr:hover td.col-battery { background-color: rgba(255, 236, 179, 0.7); }
        tr:hover td.col-flight-time { background-color: rgba(255, 205, 210, 0.7); }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .loading::after {
            content: "";
            display: inline-block;
            width: 25px;
            height: 25px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 12px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        footer {
            text-align: center;
            padding: 12px;
            background: #ecf0f1;
            color: #7f8c8d;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        /* ç§»åŠ¨è®¾å¤‡èœå•æŒ‰é’® */
        .mobile-menu-btn {
            display: none;
            position: absolute;
            top: 10px;
            left: 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            z-index: 20;
        }
        
        /* KMLå¯¼å‡ºæŒ‰é’® */
        .kml-export {
            margin-top: 15px;
            padding: 12px;
            background: #34495e;
            border-radius: 6px;
            text-align: center;
        }
        
        .kml-export-btn {
            display: inline-block;
            padding: 8px 16px;
            background: #27ae60;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 14px;
        }
        
        .kml-export-btn:hover {
            background: #219653;
        }
        
        .kml-export-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }
        
        /* ç»„åˆåŠŸèƒ½æ ·å¼ */
        .combine-checkbox {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .combine-checkbox:hover {
            border-color: #ff9800;
            background: #fff8e1;
        }
        
        .combine-checkbox input[type="checkbox"] {
            margin-right: 5px;
            cursor: pointer;
        }
        
        .combine-checkbox label {
            cursor: pointer;
            margin: 0;
            font-size: 13px;
            color: #333;
        }
        
        .saved-combination-btn {
            padding: 8px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .saved-combination-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .saved-combination-btn:active {
            transform: translateY(0);
        }
        
        .saved-combination-btn.active {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.4);
        }
        
        .combination-delete-btn {
            margin-left: 5px;
            padding: 2px 6px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            line-height: 1;
        }
        
        /* ç»„åˆç®¡ç†å¼¹çª— */
        .combination-manager {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .combination-manager-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            max-height: 60vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .combination-manager h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .combination-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .combination-item:last-child {
            border-bottom: none;
        }
        
        /* åª’ä½“æŸ¥è¯¢ - ç§»åŠ¨è®¾å¤‡ */
        @media (min-width: 768px) {
            .main-content {
                flex-direction: row;
            }
            
            .file-list {
                width: 280px;
                max-height: none;
            }
            
            .double-click-hint {
                display: block;
            }
        }
        
        @media (max-width: 767px) {
            body {
                padding: 5px;
            }
            
            .container {
                height: 98vh;
                border-radius: 10px;
            }
            
            header {
                padding: 12px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .description {
                font-size: 13px;
            }
            
            .file-list {
                position: absolute;
                top: 0;
                left: -100%;
                width: 80%;
                height: 100%;
                z-index: 15;
                transition: left 0.3s ease;
                max-height: none;
            }
            
            .file-list.active {
                left: 0;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .data-display {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            .data-item {
                padding: 10px;
            }
            
            .data-item .value {
                font-size: 14px;
            }
            
            /* è¡¨æ ¼åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šçš„ä¼˜åŒ– */
            th, td {
                padding: 8px 4px;
                font-size: 12px;
                max-width: none;
                white-space: nowrap;
            }
            
            .table-container {
                max-height: calc(100vh - 200px);
            }
            
            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10;
            }
            
            .overlay.active {
                display: block;
            }
        }
        
        @media (max-width: 480px) {
            .data-display {
                grid-template-columns: 1fr 1fr;
            }
            
            /* è¶…å°å±å¹•è¡¨æ ¼ä¼˜åŒ– */
            th, td {
                padding: 6px 3px;
                font-size: 11px;
                max-width: none;
                white-space: nowrap;
            }
            
            .table-container {
                max-height: calc(100vh - 180px);
            }
            
            .info-box {
                padding: 10px;
            }
            
            .content-area {
                padding: 10px;
            }
            
            /* ç§»åŠ¨ç«¯å›¾è¡¨ä¼˜åŒ– */
            .chart-container {
                height: 80vh !important;
                min-height: 600px !important;
                max-height: 90vh !important;
            }
            
            .chart-controls {
                flex-direction: column;
                align-items: stretch !important;
            }
            
            .chart-buttons {
                justify-content: center;
                flex-wrap: wrap !important;
            }
            
            .chart-btn {
                padding: 10px 12px;
                font-size: 12px;
                margin: 4px;
                min-height: 36px;
                min-width: 60px;
                cursor: pointer;
                -webkit-tap-highlight-color: transparent;
            }
            
            .chart-btn.touch-friendly {
                touch-action: manipulation;
            }

            /* ç§»åŠ¨ç«¯ç¼©æ”¾æ§åˆ¶æŒ‰é’®ä¼˜åŒ– */
            .chart-zoom-controls {
                bottom: 10px;
                right: 10px;
                padding: 8px;
                gap: 3px;
                grid-template-areas: 
                    "zoom-in up zoom-out"
                    "left center right"
                    ". down .";
                background-color: rgba(0, 0, 0, 0.05);
            }
            
            .chart-zoom-btn {
                padding: 8px;
                font-size: 14px;
                min-width: 40px;
                min-height: 40px;
                background: rgba(52, 152, 219, 0.25);
                border: 1px solid rgba(255, 255, 255, 0.15);
            }
            
            .chart-zoom-btn:hover {
                background: rgba(52, 152, 219, 0.4);
            }
            
            #reset-zoom-btn {
                background: rgba(255, 193, 7, 0.25);
                font-size: 10px;
                padding: 6px 2px;
            }
            
            #reset-zoom-btn:hover {
                background: rgba(255, 193, 7, 0.4);
            }
        }
        
        .chart-zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-areas: 
                ". up ."
                "left center right"
                ". down ."
                "zoom-in . zoom-out";
            gap: 2px;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 6px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        
        .chart-zoom-btn {
            padding: 6px;
            background: rgba(52, 152, 219, 0.05);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
            font-size: 8px;
            font-weight: bold;
            transition: all 0.2s;
            min-width: 22px;
            min-height: 22px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-zoom-btn:hover {
            background: rgba(52, 152, 219, 0.1);
            transform: translateY(-0.5px);
            box-shadow: 0 1.5px 3px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        .chart-zoom-btn:active {
            transform: translateY(0);
            box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.1);
            background: rgba(52, 152, 219, 0.15);
        }
        
        #pan-up-btn { grid-area: up; }
        #pan-left-btn { grid-area: left; }
        #reset-zoom-btn { 
            grid-area: center; 
            background: rgba(255, 193, 7, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
            font-size: 6px;
            padding: 4px 2px;
        }
        #reset-zoom-btn:hover {
            background: rgba(255, 193, 7, 0.1);
            border-color: rgba(255, 255, 255, 0.4);
        }
        #pan-right-btn { grid-area: right; }
        #pan-down-btn { grid-area: down; }
        #zoom-out-btn { grid-area: zoom-out; }
        #zoom-in-btn { grid-area: zoom-in; }
        #zoom-in-btn, #zoom-out-btn { 
            background: rgba(52, 152, 219, 0.05);
        }
        #zoom-in-btn:hover, #zoom-out-btn:hover {
            background: rgba(52, 152, 219, 0.1);
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none; /* è®©toastä¸æ¥å—ç‚¹å‡»äº‹ä»¶ï¼Œäº‹ä»¶å¯ä»¥ä¼ é€’ç»™ä¸‹ä¸€å±‚ */
        }
        
        .toast.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="mobile-menu-btn" id="menu-btn">â˜° æ–‡ä»¶</button>
            <h1>æ— äººæœºé£è¡Œæ•°æ®åˆ†æå·¥å…·</h1>
        </header>
        
        <div class="main-content">
            <div class="file-list" id="file-list">
                <h2 style="display:none;">æ—¥å¿—æ–‡ä»¶åˆ—è¡¨</h2>
                <div id="file-list-container">
                    <div class="loading">è¯·é€‰æ‹©æ—¥å¿—æ–‡ä»¶...</div>
                </div>
                
                <div class="double-click-hint" style="display:none;">åŒå‡»æ­¤å¤„æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨</div>
                
                <div class="file-upload">
                    <div class="file-upload-btn" id="upload-btn">é€‰æ‹©æ—¥å¿—æ–‡ä»¶</div>
                    <input type="file" id="file-input" accept=".log" multiple>
                </div>
                
                <!-- æ·»åŠ æŸ¥è¯¢æµ·æ‹”æŒ‰é’® -->
                <div class="kml-export">
                    <div class="kml-export-btn" id="query-elevation-btn">æŸ¥è¯¢æµ·æ‹”é«˜åº¦</div>
                </div>
                <!-- æ·»åŠ æµ·æ‹”é«˜åº¦-->
                <div class="kml-export">
                    <div class="kml-export-btn" id="altitude-input-btn" disabled><input type=text id=StartHaiBa size=5 placeholder="èµ·é£æµ·æ‹”"/>ç±³</div>
                </div>
                <!-- æ·»åŠ KMLå¯¼å‡ºæŒ‰é’® -->
                <div class="kml-export">
                    <div class="kml-export-btn" id="kml-export-btn" disabled>å¯¼å‡ºKMLæ–‡ä»¶</div>
                </div>
                
                <div class="kml-export">å¤šåŠŸèƒ½ç‰ˆ - æ”¯æŒæ—¥å¿—åˆ†æã€åæ ‡è½¬æ¢ã€æµ·æ‹”æŸ¥è¯¢ã€KMLå¯¼å‡º</div>
            </div>
            
            <div class="overlay" id="overlay"></div>
            
            <div class="content-area" style="overflow-y: auto;">
                <div class="info-box">
                    <h3 id="GPSset" href="#" target="_blank" onclick="openAmap(this)">é£è¡Œæ•°æ®æ‘˜è¦(ç‚¹å‡»æ‰“å¼€åæ ‡)</h3>
                    <div class="data-display">
                        <div class="data-item">
                            <label>æœ€åç»åº¦</label>
                            <a class="value" id="longitude-value">-</a>
                        </div>
                        <div class="data-item">
                            <label>æœ€åçº¬åº¦</label>
                            <a class="value" id="latitude-value">-</a>
                        </div>
                        <div class="data-item">
                            <label>é£è¡Œæ—¶é—´</label>
                            <div class="value" id="flight-time-value">-</div>
                        </div>
                        <div class="data-item">
                            <label>è½ç‚¹è·èµ·ç‚¹</label>
                            <div class="value" id="prev-distance-value">-</div>
                        </div>
                        <div class="data-item">
                            <label>æœ€é«˜é«˜åº¦</label>
                            <div class="value" id="max-height-value">-</div>
                        </div>
                        <div class="data-item">
                            <label>æœ€è¿œè·ç¦»</label>
                            <div class="value" id="max-distance-value">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
                <div class="tab-navigation" style="margin-bottom: 15px; display: flex; border-bottom: 2px solid #3498db;">
                    <button class="tab-btn" data-tab="chart-tab" style="padding: 12px 20px; background: #f8f9fa; color: #2c3e50; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: bold;">æ•°æ®å›¾è¡¨</button>
                    <button class="tab-btn active" data-tab="table-tab" style="padding: 12px 20px; background: #3498db; color: white; border: none; border-radius: 8px 8px 0 0; cursor: pointer; margin-left: 5px;">æ•°æ®åˆ—è¡¨</button>
                </div>

                <!-- å›¾è¡¨æ ‡ç­¾é¡µ -->
                <div id="chart-tab" class="tab-content" style="display: none;">
                    <!-- å›¾è¡¨æ§åˆ¶æŒ‰é’® - ç§»å‡ºåˆ°å¤–éƒ¨å·¦è§’å¹¶å±…ä¸­ -->
                    <div class="external-chart-controls" style="margin-bottom: 15px; text-align: center;">
                        <div style="display: inline-block; background: #f8f9fa; border-radius: 8px; padding: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center;">
                        <label style="font-weight: bold; color: #2c3e50;">é€‰æ‹©å›¾è¡¨æ•°æ®:</label>
                        <div class="chart-buttons" id="dynamic-chart-buttons" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button class="chart-btn active" id="show-all-data" style="background-color: #ffffff00; border-color: #2c3e50;">æ˜¾ç¤ºæ‰€æœ‰æ•°æ®</button>
                            <button class="chart-btn active" id="combine-data-btn" style="background-color: #ffffff00; border-color: #2c3e50;">ç»„åˆæ•°æ®</button>
                        </div>
                    </div>
                    
                    <!-- ç»„åˆæ•°æ®é€‰æ‹©åŒºåŸŸ -->
                    <div id="combine-selection-area" style="display: none; margin-top: 15px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 1px solid #ff9800;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #e65100;">é€‰æ‹©è¦ç»„åˆæ˜¾ç¤ºçš„æ•°æ®é¡¹</h4>
                            <button id="manage-combinations-btn" style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ç®¡ç†å·²ä¿å­˜çš„ç»„åˆé›†</button>
                        </div>
                        <div id="combine-checkboxes" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
                            <!-- åŠ¨æ€ç”Ÿæˆçš„å¤é€‰æ¡† -->
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button id="save-combination-btn" style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">ä¿å­˜ç»„åˆ</button>
                            <button id="cancel-combine-btn" style="padding: 8px 16px; background: #9e9e9e; color: white; border: none; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                            <span id="combine-info" style="color: #666; font-size: 12px;">è¯·é€‰æ‹©2ä¸ªåŠä»¥ä¸Šæ•°æ®é¡¹</span>
                        </div>
                    </div>
                    
                    <!-- å·²ä¿å­˜çš„ç»„åˆé›†æŒ‰é’®åŒºåŸŸ -->
                    <div id="saved-combinations" style="display: none; margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                        <!-- åŠ¨æ€ç”Ÿæˆçš„ç»„åˆé›†æŒ‰é’® -->
                    </div>
                            <div class="chart-zoom-controls" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                                <button class="chart-zoom-btn" id="zoom-in-btn" title="æ”¾å¤§" style="font-size: 16px; font-weight: bold;">ï¼‹</button>
                                <button class="chart-zoom-btn" id="zoom-out-btn" title="ç¼©å°" style="font-size: 16px; font-weight: bold;">ï¼</button>
                                <button class="chart-zoom-btn" id="pan-up-btn" title="å‘ä¸Šç§»åŠ¨" style="font-size: 14px;">â¬†ï¸</button>
                                <button class="chart-zoom-btn" id="pan-down-btn" title="å‘ä¸‹ç§»åŠ¨" style="font-size: 14px;">â¬‡ï¸</button>
                                <button class="chart-zoom-btn" id="pan-left-btn" title="å‘å·¦ç§»åŠ¨" style="font-size: 14px;">â¬…ï¸</button>
                                <button class="chart-zoom-btn" id="pan-right-btn" title="å‘å³ç§»åŠ¨" style="font-size: 14px;">â¡ï¸</button>
                                <button class="chart-zoom-btn" id="reset-zoom-btn" title="é‡ç½®è§†å›¾" style="font-size: 14px;">ğŸ”„</button>
                            </div>
                        </div>
                    </div>

                    <!-- å›¾è¡¨å®¹å™¨ -->
                    <div class="chart-container" style="height: 70vh; min-height: 400px; max-height: 90vh; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); display: none; touch-action: manipulation; -webkit-overflow-scrolling: touch; overflow: hidden; position: relative;">
                        <canvas id="data-chart" style="width: 100%; height: 100%; touch-action: manipulation;"></canvas>
                    </div>
                </div>

                <!-- è¡¨æ ¼æ ‡ç­¾é¡µ -->
                <div id="table-tab" class="tab-content active" style="display: block; flex: 1; min-height: 0;">
                    <div class="table-container">
                        <div class="loading" id="table-loading">é€‰æ‹©æ—¥å¿—æ–‡ä»¶åŠ è½½æ•°æ®...</div>
                        <table id="log-table" style="display: none;">
                            <thead id="table-header">
                                <!-- è¡¨å¤´å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </thead>
                            <tbody id="table-body">
                                <!-- è¡¨æ ¼æ•°æ®å°†é€šè¿‡JavaScriptå¡«å…… -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Â© 2025 æ— äººæœºé£è¡Œæ•°æ®åˆ†æç³»ç»Ÿ | åŸºäºæµè§ˆå™¨æ–‡ä»¶API</p>
        </footer>
    </div>

    <div class="toast" id="toast"></div>

    <!-- ç»„åˆç®¡ç†å¼¹çª— -->
    <div class="combination-manager" id="combination-manager">
        <div class="combination-manager-content">
            <h3>ç®¡ç†å·²ä¿å­˜çš„ç»„åˆé›†</h3>
            <div id="combination-list">
                <!-- åŠ¨æ€ç”Ÿæˆçš„ç»„åˆåˆ—è¡¨ -->
            </div>
            <div style="margin-top: 15px; text-align: center;">
                <button id="close-manager-btn" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥Chart.jsåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥Chart.jsç¼©æ”¾æ’ä»¶ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    
    <script>
        // åæ ‡è½¬æ¢å‡½æ•° - WGS84è½¬GCJ02
        function wgs84ToGcj02(lng, lat) {
            const PI = 3.1415926535897932384626;
            const a = 6378245.0;
            const ee = 0.00669342162296594323;
            
            if (outOfChina(lng, lat)) {
                return [lng, lat];
            }
            
            let dlat = transformlat(lng - 105.0, lat - 35.0);
            let dlng = transformlng(lng - 105.0, lat - 35.0);
            const radlat = lat / 180.0 * PI;
            let magic = Math.sin(radlat);
            magic = 1 - ee * magic * magic;
            const sqrtmagic = Math.sqrt(magic);
            dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
            dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);
            const mglat = lat + dlat;
            const mglng = lng + dlng;
            return [mglng, mglat];
        }
        
        function outOfChina(lng, lat) {
            return (lng < 72.004 || lng > 137.8347) || (lat < 0.8293 || lat > 55.8271);
        }
        
        function transformlat(lng, lat) {
            let ret = -100.0 + 2.0 * lng + 3.0 * lat + 0.2 * lat * lat + 0.1 * lng * lat + 0.2 * Math.sqrt(Math.abs(lng));
            ret += (20.0 * Math.sin(6.0 * lng * Math.PI) + 20.0 * Math.sin(2.0 * lng * Math.PI)) * 2.0 / 3.0;
            ret += (20.0 * Math.sin(lat * Math.PI) + 40.0 * Math.sin(lat / 3.0 * Math.PI)) * 2.0 / 3.0;
            ret += (160.0 * Math.sin(lat / 12.0 * Math.PI) + 320 * Math.sin(lat * Math.PI / 30.0)) * 2.0 / 3.0;
            return ret;
        }
        
        function transformlng(lng, lat) {
            let ret = 300.0 + lng + 2.0 * lat + 0.1 * lng * lng + 0.1 * lng * lat + 0.1 * Math.sqrt(Math.abs(lng));
            ret += (20.0 * Math.sin(6.0 * lng * Math.PI) + 20.0 * Math.sin(2.0 * lng * Math.PI)) * 2.0 / 3.0;
            ret += (20.0 * Math.sin(lng * Math.PI) && 40.0 * Math.sin(lng / 3.0 * Math.PI)) * 2.0 / 3.0;
            ret += (150.0 * Math.sin(lng / 12.0 * Math.PI) + 300.0 * Math.sin(lng / 30.0 * Math.PI)) * 2.0 / 3.0;
            return ret;
        }

        function insertDotFromRight(str, n) {
            if (n <= 0 || n > str.length) return str;
            
            const insertPos = str.length - n;
            return str.slice(0, insertPos) + '.' + str.slice(insertPos);
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // å…¨å±€åæ ‡è½¬æ¢å’Œæ ¼å¼åŒ–å‡½æ•°
        function formatAndConvertCoordinates(longitudeText, latitudeText) {
            if (!longitudeText || !latitudeText || longitudeText === '-' || latitudeText === '-') {
                return null;
            }
            
            // æ ¼å¼åŒ–åæ ‡ï¼ˆæ·»åŠ å°æ•°ç‚¹ï¼‰
            const longitude = insertDotFromRight(longitudeText, 7);
            const latitude = insertDotFromRight(latitudeText, 7);
            
            // è½¬æ¢ä¸ºæ•°å€¼
            const lng = parseFloat(longitude);
            const lat = parseFloat(latitude);
            
            if (isNaN(lng) || isNaN(lat)) {
                return null;
            }
            
            // è½¬æ¢åæ ‡åˆ°GCJ-02
            const gcj02 = wgs84ToGcj02(lng, lat);
            
            return {
                originalLng: lng,
                originalLat: lat,
                convertedLng: parseFloat(gcj02[0].toFixed(6)),
                convertedLat: parseFloat(gcj02[1].toFixed(6)),
                formattedLng: gcj02[0].toFixed(6),
                formattedLat: gcj02[1].toFixed(6)
            };
        }

        // æ‰“å¼€é«˜å¾·åœ°å›¾çš„å‡½æ•° - ä½¿ç”¨å…¨å±€åæ ‡è½¬æ¢
        function openAmap(element) {
            const longitude = document.getElementById('longitude-value').textContent;
            const latitude = document.getElementById('latitude-value').textContent;
            
            const coords = formatAndConvertCoordinates(longitude, latitude);
            if (!coords) {
                showToast('åæ ‡æ ¼å¼é”™è¯¯ï¼Œæ— æ³•æ‰“å¼€åœ°å›¾');
                return false;
            }
            
            const { formattedLng, formattedLat } = coords;
            
            // æ„å»ºé«˜å¾·åœ°å›¾URL
            const url = `https://uri.amap.com/marker?position=${formattedLng},${formattedLat}&name=æ— äººæœºä½ç½®`;
            window.open(url, '_blank');
            
            // é˜»æ­¢é»˜è®¤è¡Œä¸º
            if (event) {
                event.preventDefault();
            }
            return false;
        }

        // æå–è¡¨æ ¼éƒ¨åˆ†
        function extractTableLines(lines) {
            let tableStartIndex = -1;
            
            // æŸ¥æ‰¾è¡¨æ ¼å¼€å§‹ä½ç½®
            for (let i = 0; i < lines.length; i++) {
                // æ£€æŸ¥ç¬¬ä¸€ç§æ ¼å¼
                if (lines[i].includes('â”‡ è·ç¦»')) {
                    tableStartIndex = i;
                    break;
                }
                
                // æ£€æŸ¥ç¬¬äºŒç§æ ¼å¼
                if (lines[i].includes('UTCæ—¶é—´') && lines[i].includes(',')) {
                    tableStartIndex = i;
                    break;
                }
                
                // æ£€æŸ¥ç¬¬ä¸‰ç§æ ¼å¼
                if (lines[i].includes('â”‡â†')) {
                    tableStartIndex = i;
                    break;
                }
                
                // æ£€æŸ¥ç¬¬å››ç§æ ¼å¼
                if (lines[i].includes('TimeStamp') && lines[i].includes(',')) {
                    tableStartIndex = i;
                    break;
                }
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è¡¨æ ¼å¼€å§‹ä½ç½®ï¼Œè¿”å›ç©ºæ•°ç»„
            if (tableStartIndex === -1) {
                return [];
            }
            
            // è¿”å›ä»è¡¨æ ¼å¼€å§‹ä½ç½®åˆ°æœ«å°¾çš„æ‰€æœ‰è¡Œ
            return lines.slice(tableStartIndex);
        }
        
        // æ£€æµ‹æ—¥å¿—æ ¼å¼
        function detectLogFormat(lines) {
            if (lines.length === 0) return 'unknown';
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬ä¸€ç§æ ¼å¼
            if (lines[0].includes('â”‡ è·ç¦»') && !lines[0].includes('â”‡â†')) {
                return 'format1';
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬äºŒç§æ ¼å¼
            if (lines[0].includes('UTCæ—¶é—´') && lines[0].includes(',')) {
                return 'format2';
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬ä¸‰ç§æ ¼å¼
            if (lines[0].includes('â”‡â†')) {
                return 'format3';
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬å››ç§æ ¼å¼
            if (lines[0].includes('TimeStamp') && lines[0].includes(',')) {
                return 'format4';
            }
            
            return 'unknown';
        }

        // å…¨å±€å˜é‡å­˜å‚¨å½“å‰æ—¥å¿—æ•°æ®
        let currentLogData = [];
        let currentLogFileName = '';


 // ç”ŸæˆKMLæ–‡ä»¶çš„å‡½æ•°
function generateKML() {
    if (currentLogData.length === 0) {
        showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
        return null;
    }
    let StartAlt = document.getElementById("StartHaiBa").value;
    if (StartAlt === "") StartAlt = 0; else StartAlt = Number(StartAlt);
    try {
        // æå–è¡¨æ ¼è¡Œ
        const tableLines = extractTableLines(currentLogData);
        if (tableLines.length === 0) {
            showToast('æœªæ‰¾åˆ°è¡¨æ ¼æ•°æ®');
            return null;
        }
        
        // æ£€æµ‹æ—¥å¿—æ ¼å¼
        const formatType = detectLogFormat(tableLines);
        const coordinates = [];
        const extendedData = []; // å­˜å‚¨æ‰©å±•æ•°æ®
        
        // å­˜å‚¨é£è¡Œæ—¶é—´æ•°æ®
        let flightTimes = [];
        let flightTimeIndex = -1;
        
        // æ ¹æ®æ ¼å¼æå–åæ ‡å’Œé£è¡Œæ•°æ®
        if (formatType === 'format1') {
            // æ ¼å¼1å¤„ç† - åŒ…å«è¯¦ç»†é£è¡Œæ•°æ®
            // æ‰¾åˆ°é£è¡Œæ—¶é—´åˆ—çš„ç´¢å¼•
            const headers = tableLines[0].split('â”‡').map(h => h.trim()).filter(h => h !== '');
            headers.forEach((header, index) => {
                if (header.includes('ç´¯è®¡é£è¡Œ') || header.includes('é£è¡Œæ—¶é—´')) {
                    flightTimeIndex = index;
                }
            });
            
            // æå–é£è¡Œæ—¶é—´æ•°æ®
            for (let i = 1; i < tableLines.length; i++) {
                if (tableLines[i].trim() === '') continue;
                
                const columns = tableLines[i].split('â”‡').map(c => c.trim());
                if (columns.length < 12) continue;
                
                if (flightTimeIndex !== -1 && columns[flightTimeIndex]) {
                    flightTimes.push({
                        index: i,
                        time: columns[flightTimeIndex],
                        value: parseFlightTimeToSeconds(columns[flightTimeIndex])
                    });
                }
            }
            
            // ç¡®å®šèµ·ç‚¹å’Œè½ç‚¹
            const { startIndex, endIndex } = determineFlightStartEnd(flightTimes, tableLines.length);
            
            // æå–èµ·ç‚¹åˆ°è½ç‚¹ä¹‹é—´çš„åæ ‡
            for (let i = Math.max(1, startIndex); i <= Math.min(tableLines.length - 1, endIndex); i++) {
                if (tableLines[i].trim() === '') continue;
                
                const columns = tableLines[i].split('â”‡').map(c => c.trim());
                if (columns.length < 12) continue;
                
                // æå–ç»çº¬åº¦å’Œé«˜åº¦
                const lng = columns[3];
                const lat = columns[4];
                const alt = columns[2] ? columns[2].replace('M', '') : '0';
                
                if (lng && lat && !isNaN(parseFloat(lng)) && !isNaN(parseFloat(lat))) {
                    // å¤„ç†åæ ‡
                    const coordLng = parseFloat(insertDotFromRight(lng, 7));
                    const coordLat = parseFloat(insertDotFromRight(lat, 7));
                    let coordAlt = parseFloat(alt) || 0;
                    coordAlt += StartAlt;
                    
                    coordinates.push(`${coordLng},${coordLat},${coordAlt}`);
                    
                    // æå–é£è¡Œæ•°æ®
                    const time = columns[0] || '';
                    const distance = columns[1] || '';
                    const speed = columns[5] ? Math.abs(parseFloat(columns[5])) : 0;
                    const verticalSpeed = columns[6] ? Math.abs(parseFloat(columns[6])) : 0;
                    const satellites = columns[7] || '';
                    const direction = columns[8] || '';
                    const angle = columns[9] || '';
                    const battery = columns[10] || '';
                    const flightTime = columns[11] || '';
                    
                    // å­˜å‚¨æ‰©å±•æ•°æ®
                    extendedData.push({
                        time,
                        distance,
                        height: alt,
                        speed,
                        verticalSpeed,
                        satellites,
                        direction,
                        angle,
                        battery,
                        flightTime
                    });
                }
            }
        } else if (formatType === 'format2') {
            // æ ¼å¼2å¤„ç† - ä¿æŒåŸæœ‰æ–¹å¼
            const headers = tableLines[0].split(',').map(h => h.trim());
            
            // æŸ¥æ‰¾ç»åº¦ã€çº¬åº¦å’Œé«˜åº¦çš„åˆ—ç´¢å¼•
            let lngIndex = -1, latIndex = -1, altIndex = -1;
            
            headers.forEach((header, index) => {
                if (header === 'ç»åº¦') lngIndex = index;
                else if (header === 'çº¬åº¦') latIndex = index;
                else if (header === 'é«˜åº¦') altIndex = index;
                else if (header.includes('ç´¯è®¡é£è¡Œ') || header.includes('é£è¡Œæ—¶é—´')) {
                    flightTimeIndex = index;
                }
            });
            
            // æå–é£è¡Œæ—¶é—´æ•°æ®
            for (let i = 1; i < tableLines.length; i++) {
                if (tableLines[i].trim() === '') continue;
                
                const columns = tableLines[i].split(',').map(c => c.trim());
                if (columns.length < headers.length) continue;
                
                if (flightTimeIndex !== -1 && columns[flightTimeIndex]) {
                    flightTimes.push({
                        index: i,
                        time: columns[flightTimeIndex],
                        value: parseFlightTimeToSeconds(columns[flightTimeIndex])
                    });
                }
            }
            
            // ç¡®å®šèµ·ç‚¹å’Œè½ç‚¹
            const { startIndex, endIndex } = determineFlightStartEnd(flightTimes, tableLines.length);
            
            for (let i = Math.max(1, startIndex); i <= Math.min(tableLines.length - 1, endIndex); i++) {
                if (tableLines[i].trim() === '') continue;
                
                const columns = tableLines[i].split(',').map(c => c.trim());
                if (columns.length < headers.length) continue;
                
                const lng = lngIndex !== -1 ? columns[lngIndex] : null;
                const lat = latIndex !== -1 ? columns[latIndex] : null;
                const alt = altIndex !== -1 ? columns[altIndex] : '0';
                
                if (lng && lat && !isNaN(parseFloat(lng)) && !isNaN(parseFloat(lat))) {
                    coordinates.push(`${parseFloat(insertDotFromRight(lng, 7))},${parseFloat(insertDotFromRight(lat, 7))},${(parseFloat(alt) || 0)+StartAlt}`);
                }
            }
        } else if (formatType === 'format3') {
            // æ ¼å¼3å¤„ç† - åŒ…å«è¯¦ç»†é£è¡Œæ•°æ®
            const headers = tableLines[0].split('â”‡').map(h => h.trim()).filter(h => h !== '');
            
            // æŸ¥æ‰¾å…³é”®åˆ—çš„ç´¢å¼•
            let lngIndex = -1, latIndex = -1, altIndex = -1;
            let timeIndex = -1, distIndex = -1, speedIndex = -1, vspeedIndex = -1;
            let satIndex = -1, dirIndex = -1, angleIndex = -1, batteryIndex = -1, flightTimeIndex = -1;
            
            headers.forEach((header, index) => {
                if (header === 'ç»åº¦') lngIndex = index;
                else if (header === 'çº¬åº¦') latIndex = index;
                else if (header === 'é«˜åº¦') altIndex = index;
                else if (header === 'å½“å‰æ—¶é—´') timeIndex = index;
                else if (header === 'è·ç¦»') distIndex = index;
                else if (header === 'å‰è¿›é€Ÿåº¦') speedIndex = index;
                else if (header === 'ä¸Šå‡é€Ÿåº¦') vspeedIndex = index;
                else if (header === 'å«æ˜Ÿ') satIndex = index;
                else if (header === 'æ–¹å‘') dirIndex = index;
                else if (header === 'å€¾è§’') angleIndex = index;
                else if (header === 'ç”µé‡') batteryIndex = index;
                else if (header === 'ç´¯è®¡é£è¡Œ') flightTimeIndex = index;
            });
            
            // æå–é£è¡Œæ—¶é—´æ•°æ®
            for (let i = 1; i < tableLines.length; i++) {
                if (tableLines[i].trim() === '') continue;
                
                const columns = tableLines[i].split('â”‡').map(c => c.trim()).filter(c => c !== '');
                if (columns.length < headers.length) continue;
                
                if (flightTimeIndex !== -1 && columns[flightTimeIndex]) {
                    flightTimes.push({
                        index: i,
                        time: columns[flightTimeIndex],
                        value: parseFlightTimeToSeconds(columns[flightTimeIndex])
                    });
                }
            }
            
            // ç¡®å®šèµ·ç‚¹å’Œè½ç‚¹
            const { startIndex, endIndex } = determineFlightStartEnd(flightTimes, tableLines.length);
            
            for (let i = Math.max(1, startIndex); i <= Math.min(tableLines.length - 1, endIndex); i++) {
                if (tableLines[i].trim() === '') continue;
                
                const columns = tableLines[i].split('â”‡').map(c => c.trim()).filter(c => c !== '');
                if (columns.length < headers.length) continue;
                
                const lng = lngIndex !== -1 ? columns[lngIndex] : null;
                const lat = latIndex !== -1 ? columns[latIndex] : null;
                const alt = altIndex !== -1 ? columns[altIndex].replace('M', '') : '0';
                
                if (lng && lat && !isNaN(parseFloat(lng)) && !isNaN(parseFloat(lat))) {
                    // å¤„ç†åæ ‡
                    const coordLng = parseFloat(insertDotFromRight(lng, 7));
                    const coordLat = parseFloat(insertDotFromRight(lat, 7));
                    let coordAlt = parseFloat(alt) || 0;
                    coordAlt += StartAlt;
                    
                    coordinates.push(`${coordLng},${coordLat},${coordAlt}`);
                    
                    // æå–é£è¡Œæ•°æ®
                    const time = timeIndex !== -1 ? columns[timeIndex] : '';
                    const distance = distIndex !== -1 ? columns[distIndex] : '';
                    const speed = speedIndex !== -1 ? Math.abs(parseFloat(columns[speedIndex] || 0)) : 0;
                    const verticalSpeed = vspeedIndex !== -1 ? Math.abs(parseFloat(columns[vspeedIndex] || 0)) : 0;
                    const satellites = satIndex !== -1 ? columns[satIndex] : '';
                    const direction = dirIndex !== -1 ? columns[dirIndex] : '';
                    const angle = angleIndex !== -1 ? columns[angleIndex] : '';
                    const battery = batteryIndex !== -1 ? columns[batteryIndex] : '';
                    const flightTime = flightTimeIndex !== -1 ? columns[flightTimeIndex] : '';
                    
                    // å­˜å‚¨æ‰©å±•æ•°æ®
                    extendedData.push({
                        time,
                        distance,
                        height: alt,
                        speed,
                        verticalSpeed,
                        satellites,
                        direction,
                        angle,
                        battery,
                        flightTime
                    });
                }
            }
        } else if (formatType === 'format4') {
            // æ ¼å¼4å¤„ç† - ä¿æŒåŸæœ‰æ–¹å¼
            const headers = tableLines[0].split(',').map(h => h.trim());
            
            // æŸ¥æ‰¾ç»åº¦ã€çº¬åº¦å’Œé«˜åº¦çš„åˆ—ç´¢å¼•
            let lngIndex = -1, latIndex = -1, altIndex = -1;
            
            headers.forEach((header, index) => {
                if (header.toLowerCase() === 'lon' || header.toLowerCase() === 'longitude') lngIndex = index;
                else if (header.toLowerCase() === 'lat' || header.toLowerCase() === 'latitude') latIndex = index;
                else if (header.toLowerCase() === 'alt' || header.toLowerCase() === 'altitude' || header.toLowerCase() === 'height') altIndex = index;
                else if (header.includes('ç´¯è®¡é£è¡Œ') || header.includes('é£è¡Œæ—¶é—´')) {
                    flightTimeIndex = index;
                }
            });
            
            // æå–é£è¡Œæ—¶é—´æ•°æ®
            for (let i = 1; i < tableLines.length; i++) {
                if (tableLines[i].trim() === '') continue;
                
                const columns = tableLines[i].split(',').map(c => c.trim());
                if (columns.length < headers.length) continue;
                
                if (flightTimeIndex !== -1 && columns[flightTimeIndex]) {
                    flightTimes.push({
                        index: i,
                        time: columns[flightTimeIndex],
                        value: parseFlightTimeToSeconds(columns[flightTimeIndex])
                    });
                }
            }
            
            // ç¡®å®šèµ·ç‚¹å’Œè½ç‚¹
            const { startIndex, endIndex } = determineFlightStartEnd(flightTimes, tableLines.length);
            
            for (let i = Math.max(1, startIndex); i <= Math.min(tableLines.length - 1, endIndex); i++) {
                if (tableLines[i].trim() === '') continue;
                
                const columns = tableLines[i].split(',').map(c => c.trim());
                if (columns.length < headers.length) continue;
                
                const lng = lngIndex !== -1 ? columns[lngIndex] : null;
                const lat = latIndex !== -1 ? columns[latIndex] : null;
                const alt = altIndex !== -1 ? columns[altIndex] : '0';
                
                if (lng && lat && !isNaN(parseFloat(lng)) && !isNaN(parseFloat(lat))) {
                    coordinates.push(`${parseFloat(insertDotFromRight(lng, 7))},${parseFloat(insertDotFromRight(lat, 7))},${(parseFloat(alt) || 0)+StartAlt}`);
                }
            }
        } else {
            showToast('æ— æ³•è¯†åˆ«çš„æ—¥å¿—æ ¼å¼');
            return null;
        }
        
        if (coordinates.length === 0) {
            showToast('æœªæ‰¾åˆ°æœ‰æ•ˆçš„åæ ‡æ•°æ®');
            return null;
        }
        
        // åˆ›å»ºKMLå†…å®¹
        let kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
    <name>æ— äººæœºé£è¡Œè½¨è¿¹ - ${currentLogFileName}</name>
    <description>æ— äººæœºé£è¡Œè½¨è¿¹è®°å½•</description>
    <Style id="trackStyle">
        <LineStyle>
            <color>ff00ffff</color>
            <width>4</width>
        </LineStyle>
        <PolyStyle>
            <color>7f00ff00</color>
        </PolyStyle>
    </Style>
    <Style id="pointStyle">
        <IconStyle>
            <scale>0.5</scale>
            <Icon>
                <href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href>
            </Icon>
        </IconStyle>
    </Style>
    <Folder>
        <name>é£è¡Œè½¨è¿¹</name>
        <Placemark>
            <name>é£è¡Œè·¯å¾„</name>
            <description>æ— äººæœºé£è¡Œè½¨è¿¹çº¿</description>
            <styleUrl>#trackStyle</styleUrl>
            <LineString>
                <extrude>1</extrude>
                <tessellate>1</tessellate>
                <altitudeMode>absolute</altitudeMode>
                <coordinates>
                    ${coordinates.join(' ')}
                </coordinates>
            </LineString>
        </Placemark>
    </Folder>
    <Folder>
        <name>å…³é”®ç‚¹</name>
        <Placemark>
            <name>èµ·é£ç‚¹</name>
            <description>æ— äººæœºèµ·é£ä½ç½®</description>
            <Style>
                <IconStyle>
                    <color>ff00ff00</color>
                    <scale>1.2</scale>
                    <Icon>
                        <href>http://maps.google.com/mapfiles/kml/shapes/triangle.png</href>
                    </Icon>
                </IconStyle>
            </Style>
            <Point>
                <coordinates>${coordinates[0]}</coordinates>
            </Point>
        </Placemark>
        <Placemark>
            <name>é™è½ç‚¹</name>
            <description>æ— äººæœºé™è½ä½ç½®</description>
            <Style>
                <IconStyle>
                    <color>ff0000ff</color>
                    <scale>1.2</scale>
                    <Icon>
                        <href>http://maps.google.com/mapfiles/kml/shapes/triangle.png</href>
                    </Icon>
                </IconStyle>
            </Style>
            <Point>
                <coordinates>${coordinates[coordinates.length - 1]}</coordinates>
            </Point>
        </Placemark>
    </Folder>
</Document>
</kml>`;
        
        return kmlContent;
    } catch (error) {
        showToast('ç”ŸæˆKMLæ—¶å‡ºé”™: ' + error.message);
        return null;
    }
}

// è§£æé£è¡Œæ—¶é—´åˆ°ç§’æ•°
function parseFlightTimeToSeconds(timeStr) {
    if (!timeStr) return 0;
    
    // å¤„ç† HH:MM:SS æ ¼å¼
    if (timeStr.includes(':')) {
        const parts = timeStr.split(':');
        if (parts.length === 3) {
            return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
        }
    }
    
    // å¤„ç†çº¯æ•°å­—æ ¼å¼ï¼ˆç§’ï¼‰
    return parseFloat(timeStr) || 0;
}

// ç¡®å®šé£è¡Œå¼€å§‹å’Œç»“æŸçš„ç´¢å¼•
function determineFlightStartEnd(flightTimes, totalLines) {
    if (flightTimes.length === 0) {
        // å¦‚æœæ²¡æœ‰é£è¡Œæ—¶é—´æ•°æ®ï¼Œä½¿ç”¨æ‰€æœ‰æ•°æ®
        return { startIndex: 1, endIndex: totalLines - 1 };
    }
    
    let startIndex = 1; // é»˜è®¤ä»ç¬¬ä¸€è¡Œå¼€å§‹
    let endIndex = totalLines - 1; // é»˜è®¤åˆ°æœ€åä¸€è¡Œç»“æŸ
    
    // æ‰¾åˆ°é£è¡Œæ—¶é—´å¼€å§‹å¢åŠ çš„èµ·ç‚¹
    let flightStarted = false;
    let maxTime = 0;
    let maxTimeIndex = 0;
    
    for (let i = 0; i < flightTimes.length; i++) {
        const currentTime = flightTimes[i].value;
        
        // è®°å½•æœ€å¤§é£è¡Œæ—¶é—´å’Œå¯¹åº”ç´¢å¼•
        if (currentTime > maxTime) {
            maxTime = currentTime;
            maxTimeIndex = flightTimes[i].index;
        }
        
        // å¦‚æœé£è¡Œæ—¶é—´å¼€å§‹å¢åŠ ï¼ˆå¤§äº0ï¼‰ï¼Œå¹¶ä¸”ä¹‹å‰æ²¡æœ‰å¼€å§‹é£è¡Œ
        if (!flightStarted && currentTime > 0) {
            flightStarted = true;
            // å¦‚æœè¿™æ˜¯ç¬¬ä¸€è¡Œæ•°æ®ï¼Œåˆ™èµ·ç‚¹å°±æ˜¯ç¬¬ä¸€è¡Œ
            // å¦åˆ™ï¼Œèµ·ç‚¹æ˜¯å½“å‰è¡Œçš„ä¸Šä¸€è¡Œï¼ˆå› ä¸ºé£è¡Œæ—¶é—´å¼€å§‹å¢åŠ çš„å‰ä¸€è¡Œæ˜¯èµ·é£ç‚¹ï¼‰
            startIndex = (i === 0) ? flightTimes[i].index : flightTimes[i-1].index;
        }
    }
    
    // æ‰¾åˆ°é£è¡Œæ—¶é—´ä¸å†å¢åŠ çš„ç»ˆç‚¹
    // ä»æœ€å¤§é£è¡Œæ—¶é—´çš„ä½ç½®å¼€å§‹å‘åæ‰¾ï¼Œç›´åˆ°é£è¡Œæ—¶é—´ä¸å†å¢åŠ æˆ–å¼€å§‹å‡å°‘
    let flightEnded = false;
    for (let i = flightTimes.findIndex(ft => ft.index === maxTimeIndex); i < flightTimes.length; i++) {
        if (i === flightTimes.length - 1) {
            // å¦‚æœæ˜¯æœ€åä¸€è¡Œï¼Œåˆ™ç»ˆç‚¹å°±æ˜¯æœ€åä¸€è¡Œ
            endIndex = flightTimes[i].index;
            flightEnded = true;
            break;
        }
        
        // å¦‚æœä¸‹ä¸€è¡Œçš„é£è¡Œæ—¶é—´å°äºæˆ–ç­‰äºå½“å‰è¡Œï¼Œè¯´æ˜é£è¡Œå·²ç»ç»“æŸ
        if (flightTimes[i+1].value <= flightTimes[i].value) {
            endIndex = flightTimes[i].index;
            flightEnded = true;
            break;
        }
    }
    
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ˜ç¡®çš„ç»ˆç‚¹ï¼Œä½¿ç”¨æœ€å¤§é£è¡Œæ—¶é—´çš„ä½ç½®
    if (!flightEnded) {
        endIndex = maxTimeIndex;
    }
    
    return { startIndex, endIndex };
}

        // ä¸‹è½½KMLæ–‡ä»¶çš„å‡½æ•°
        function downloadKML() {
            const kmlContent = generateKML();
            if (!kmlContent) return;
            
            try {
                // åˆ›å»ºBlobå¯¹è±¡
                const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
                const url = URL.createObjectURL(blob);
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const a = document.createElement('a');
                a.href = url;
                
                // ä½¿ç”¨æ—¥å¿—æ–‡ä»¶åå’Œå½“å‰æ—¥æœŸæ—¶é—´ä½œä¸ºæ–‡ä»¶å
                const now = new Date();
                const fileName = `æ— äººæœºè½¨è¿¹_${currentLogFileName.replace('.log', '')}.kml`;
                a.download = fileName;
                
                // è§¦å‘ä¸‹è½½
                document.body.appendChild(a);
                a.click();
                
                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                showToast('KMLæ–‡ä»¶å·²ç”Ÿæˆå¹¶å¼€å§‹ä¸‹è½½');
            } catch (error) {
                showToast('ä¸‹è½½KMLæ—¶å‡ºé”™: ' + error.message);
            }
        }

        // å›¾è¡¨ç›¸å…³å˜é‡
        let dataChart = null;
        let chartData = {
            labels: [],
            datasets: {}
        };
        
        // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        function initTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                    tabBtns.forEach(b => {
                        b.classList.remove('active');
                        b.style.background = '#f8f9fa';
                        b.style.color = '#2c3e50';
                    });
                    tabContents.forEach(content => content.style.display = 'none');
                    
                    // æ¿€æ´»å½“å‰æ ‡ç­¾é¡µ
                    btn.classList.add('active');
                    btn.style.background = '#3498db';
                    btn.style.color = 'white';
                    const tabId = btn.getAttribute('data-tab');
                    const tabElement = document.getElementById(tabId);
                    tabElement.style.display = 'block';
                    
                    // è‡ªåŠ¨æ»šåŠ¨åˆ°æ˜¾ç¤ºåŒºåŸŸ
                    tabElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });
        }
        
        // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            // æ³¨å†Œç¼©æ”¾æ’ä»¶
            Chart.register(ChartZoom);
            
            // ç§»åŠ¨ç«¯ç‰¹å®šé…ç½®
            const isMobile = isMobileDevice();
            
            const ctx = document.getElementById('data-chart').getContext('2d');
            dataChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    // ç§»åŠ¨ç«¯ä¼˜åŒ–é…ç½®
                    devicePixelRatio: window.devicePixelRatio || 1,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                        // ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ–
                        includeInvisible: true
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'æ— äººæœºé£è¡Œæ•°æ®æ›²çº¿',
                            font: { size: 16 }
                        },
                        legend: {
                            position: 'top',
                        },
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: !isMobile, // ç§»åŠ¨ç«¯ç¦ç”¨æ»šè½®ç¼©æ”¾
                                },
                                pinch: {
                                    enabled: true,
                                },
                                mode: 'xy',
                            },
                            pan: {
                                enabled: true,
                                mode: 'xy',
                                threshold: isMobile ? 5 : 10, // ç§»åŠ¨ç«¯é™ä½é˜ˆå€¼
                                speed: isMobile ? 5 : 10, // ç§»åŠ¨ç«¯é™ä½é€Ÿåº¦
                                modifierKey: null
                            },
                            selection: {
                                enabled: true,
                                mode: 'xy',
                                backgroundColor: 'rgba(52, 152, 219, 0.3)',
                                borderColor: 'rgba(52, 152, 219, 0.8)',
                                borderWidth: 2
                            }
                        },
                        tooltip: {
                            enabled: true,
                            intersect: false,
                            mode: 'index',
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    
                                    const value = context.parsed.y;
                                    
                                    // å¦‚æœæ˜¯é£è¡Œæ—¶é—´ï¼Œæ ¼å¼åŒ–ä¸ºæ—¶åˆ†ç§’
                                    if (context.dataset.label && context.dataset.label.includes('ç´¯è®¡é£è¡Œ')) {
                                        return label + formatFlightTime(value);
                                    }
                                    
                                    return label + value;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'æ•°å€¼'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´åºåˆ—'
                            }
                        }
                    }
                }
            });
        }
        
        // æ·»åŠ çª—å£å¤§å°å˜åŒ–æ—¶çš„å›¾è¡¨è°ƒæ•´
        function initChartResizeHandler() {
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    if (dataChart) {
                        dataChart.resize();
                        dataChart.update('none');
                    }
                }, 250);
            });
        }
        
        // å¤„ç†å›¾è¡¨æ•°æ®
        function processChartData(lines, formatType) {
            chartData = { labels: [], datasets: {} };
            
            // ä½¿ç”¨ç»Ÿä¸€çš„å¤„ç†å‡½æ•°å¤„ç†æ‰€æœ‰æ ¼å¼
            processAllChartData(lines, formatType);
            
            // é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰æ•°æ®
            showAllDataItems();
            
            // åˆ·æ–°ç»„åˆé€‰æ‹©åŒºåŸŸçš„æ•°æ®é¡¹
            if (document.getElementById('combine-selection-area') && 
                document.getElementById('combine-selection-area').style.display !== 'none') {
                showCombineSelection();
            }
            
            // åˆ·æ–°å·²ä¿å­˜çš„ç»„åˆæŒ‰é’®
            loadSavedCombinations();
        }
        
        // å¤„ç†æ ¼å¼1çš„å›¾è¡¨æ•°æ® - ä½¿ç”¨ç»Ÿä¸€å¤„ç†å‡½æ•°
        function processFormat1ChartData(lines) {
            processAllChartData(lines, 'format1');
        }
        
        // å¤„ç†æ ¼å¼3çš„å›¾è¡¨æ•°æ® - ä½¿ç”¨ç»Ÿä¸€å¤„ç†å‡½æ•°
        function processFormat3ChartData(lines) {
            processAllChartData(lines, 'format3');
        }
        

        
        // æ·»åŠ åˆ°æ•°æ®é›† - æ”¯æŒåŠ¨æ€åˆ—å
        function addToDataset(field, value) {
            if (!chartData.datasets[field]) {
                chartData.datasets[field] = [];
            }
            chartData.datasets[field] = value; // ç›´æ¥èµ‹å€¼æ•´ä¸ªæ•°ç»„
        }
        
        // æ›´æ–°å›¾è¡¨æ˜¾ç¤º - ä¼˜åŒ–ç‰ˆ
        function updateChart(field) {
            if (!dataChart) return;
            
            // è·³è¿‡ç»çº¬åº¦å­—æ®µ
            if (!shouldShowInChart(field)) {
                return;
            }
            
            // é‡ç½®æ‰€æœ‰æŒ‰é’®æ ·å¼
            const chartButtons = document.querySelectorAll('.chart-btn');
            chartButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.backgroundColor = ''; // é‡ç½®èƒŒæ™¯è‰²
            });
            
            // é‡ç½®å·²ä¿å­˜ç»„åˆæŒ‰é’®çš„æ ·å¼
            resetCombinationButtons();
            
            // è®¾ç½®å½“å‰å­—æ®µæŒ‰é’®ä¸ºæ¿€æ´»çŠ¶æ€
            const fieldButton = document.querySelector(`.chart-btn[data-field="${field}"]`);
            if (fieldButton) {
                fieldButton.classList.add('active');
                fieldButton.style.backgroundColor = '#8593ab'; // è®¾ç½®èƒŒæ™¯è‰²
            }
            
            // å¦‚æœè¯¥å­—æ®µæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            if (!chartData.datasets[field] || chartData.datasets[field].length === 0) {
                showToast('å½“å‰æ—¥å¿—æ–‡ä»¶ä¸­æ²¡æœ‰' + getFieldLabel(field) + 'æ•°æ®');
                return;
            }
            
            // è·å–åŸå§‹æ•°æ®å¹¶é™é‡‡æ ·
            const originalData = chartData.datasets[field];
            const MAX_POINTS = 2000; // å•ä¸ªå›¾è¡¨å…è®¸æ›´å¤šæ•°æ®ç‚¹
            const sampledData = downsampleData(originalData, MAX_POINTS);
            
            // æ ‡ç­¾é™é‡‡æ ·
            const labelStep = Math.ceil(chartData.labels.length / MAX_POINTS);
            const sampledLabels = [];
            for (let i = 0; i < chartData.labels.length; i += labelStep) {
                sampledLabels.push(chartData.labels[i]);
            }
            
            // ä¼˜åŒ–å›¾è¡¨é…ç½®
            dataChart.options.animation = false; // ç¦ç”¨åŠ¨ç”»æå‡æ€§èƒ½
            dataChart.options.responsive = true;
            dataChart.options.maintainAspectRatio = false;
            
            // åˆ›å»ºä¼˜åŒ–åçš„æ•°æ®é›†
            const dataset = {
                label: getFieldLabel(field), // ä½¿ç”¨ä¸­æ–‡æ ‡ç­¾
                data: sampledData,
                borderColor: getFieldColor(field),
                backgroundColor: getFieldColor(field) + '20',
                borderWidth: 2,
                fill: false,
                tension: 0.1,
                pointRadius: 0, // å‡å°‘æ•°æ®ç‚¹æ˜¾ç¤ºæå‡æ€§èƒ½
                pointHoverRadius: 3,
                pointHitRadius: 5
            };
            

            
            dataChart.data = {
                labels: sampledLabels,
                datasets: [dataset]
            };
            
            // æ— åŠ¨ç”»å¿«é€Ÿæ›´æ–°
            dataChart.update('none');
            
            // é‡ç½®ç¼©æ”¾çŠ¶æ€
            if (dataChart.resetZoom) {
                dataChart.resetZoom();
            }
            
            // ç¡®ä¿å›¾è¡¨åœ¨ç§»åŠ¨ç«¯æ­£ç¡®æ˜¾ç¤º
            setTimeout(() => {
                if (dataChart) {
                    dataChart.update('none'); // é™é»˜æ›´æ–°ï¼Œé¿å…é—ªçƒ
                }
            }, 100);
            
            // æ˜¾ç¤ºå›¾è¡¨å®¹å™¨
            document.querySelector('.chart-container').style.display = 'block';
            
            const dataInfo = originalData.length > MAX_POINTS ? 
                `${getFieldLabel(field)} (${sampledData.length}/${originalData.length}ç‚¹)` : 
                getFieldLabel(field);
            
            showToast(`æ˜¾ç¤º ${dataInfo} æ•°æ®`);
        }
        
        // æ•°æ®é™é‡‡æ ·å‡½æ•° - ä¼˜åŒ–æ€§èƒ½
        function downsampleData(data, maxPoints = 1000) {
            if (!data || data.length <= maxPoints) return data;
            
            const step = Math.ceil(data.length / maxPoints);
            const sampledData = [];
            
            for (let i = 0; i < data.length; i += step) {
                sampledData.push(data[i]);
            }
            
            return sampledData;
        }
        
        // æ˜¾ç¤ºæ‰€æœ‰æ•°æ®é¡¹ - ä¼˜åŒ–ç‰ˆ
        function showAllDataItems() {
            if (!dataChart) {
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
            const hasData = Object.values(chartData.datasets).some(dataset => dataset && dataset.length > 0);
            
            if (!hasData) {
                showToast('å½“å‰æ²¡æœ‰å¯ç”¨çš„æ•°æ®');
                return;
            }
            
            // æ€§èƒ½æ£€æŸ¥ï¼šè®¡ç®—æ€»æ•°æ®ç‚¹æ•°
            let totalDataPoints = 0;
            Object.keys(chartData.datasets).forEach(field => {
                if (chartData.datasets[field]) {
                    totalDataPoints += chartData.datasets[field].length;
                }
            });
            
            // æ•°æ®é™é‡‡æ ·é˜ˆå€¼
            const MAX_POINTS_PER_DATASET = 1000;
            const MAX_TOTAL_POINTS = 5000;
            
            if (totalDataPoints > MAX_TOTAL_POINTS) {
                showToast(`æ•°æ®é‡è¾ƒå¤§(${totalDataPoints}ç‚¹)ï¼Œæ­£åœ¨ä¼˜åŒ–æ˜¾ç¤º...`);
            }
            
            // ç¡®ä¿æ˜¾ç¤ºæ‰€æœ‰æ•°æ®æŒ‰é’®ä¿æŒæ¿€æ´»çŠ¶æ€
            const chartButtons = document.querySelectorAll('.chart-btn');
            chartButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.backgroundColor = ''; // é‡ç½®èƒŒæ™¯è‰²
            });
            
            // é‡ç½®å·²ä¿å­˜ç»„åˆæŒ‰é’®çš„æ ·å¼
            resetCombinationButtons();
            
            const showAllDataBtn = document.getElementById('show-all-data');
            if (showAllDataBtn) {
                showAllDataBtn.classList.add('active');
                showAllDataBtn.style.backgroundColor = '#8593ab'; // è®¾ç½®èƒŒæ™¯è‰²
            }
            
            // ä¼˜åŒ–å›¾è¡¨é…ç½®
            dataChart.options.animation = false; // ç¦ç”¨åŠ¨ç”»æå‡æ€§èƒ½
            dataChart.options.responsive = true;
            dataChart.options.maintainAspectRatio = false;
            
            // åˆ›å»ºåŒ…å«æ‰€æœ‰æ•°æ®å­—æ®µçš„æ•°æ®é›† - ä½¿ç”¨é™é‡‡æ ·
            const datasets = [];
            
            Object.keys(chartData.datasets).forEach(field => {
                // è·³è¿‡ç»çº¬åº¦å­—æ®µ
                if (!shouldShowInChart(field)) {
                    return;
                }
                
                if (chartData.datasets[field] && chartData.datasets[field].length > 0) {
                    const originalData = chartData.datasets[field];
                    const sampledData = downsampleData(originalData, MAX_POINTS_PER_DATASET);
                    
                    const dataset = {
                        label: getFieldLabel(field),
                        data: sampledData,
                        borderColor: getFieldColor(field),
                        backgroundColor: getFieldColor(field) + '20',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0, // å‡å°‘æ•°æ®ç‚¹æ˜¾ç¤ºæå‡æ€§èƒ½
                        pointHoverRadius: 3
                    };
                    datasets.push(dataset);
                }
            });
            
            if (datasets.length === 0) {
                showToast('å½“å‰æ²¡æœ‰å¯ç”¨çš„æ•°æ®');
                return;
            }
            
            // æ ‡ç­¾ä¹Ÿè¿›è¡Œé™é‡‡æ ·ä»¥åŒ¹é…æ•°æ®
            const labelStep = Math.ceil(chartData.labels.length / MAX_POINTS_PER_DATASET);
            const sampledLabels = [];
            for (let i = 0; i < chartData.labels.length; i += labelStep) {
                sampledLabels.push(chartData.labels[i]);
            }
            

            
            dataChart.data = {
                labels: sampledLabels,
                datasets: datasets
            };
            
            // å¼ºåˆ¶æ›´æ–°å›¾è¡¨
            dataChart.update('none'); // æ— åŠ¨ç”»æ›´æ–°
            
            // é‡ç½®ç¼©æ”¾çŠ¶æ€
            if (dataChart.resetZoom) {
                dataChart.resetZoom();
            }
            
            // æ˜¾ç¤ºå›¾è¡¨å®¹å™¨
            document.querySelector('.chart-container').style.display = 'block';
            
            showToast(`å·²ä¼˜åŒ–æ˜¾ç¤º ${datasets.length} ä¸ªæ•°æ®é¡¹`);

        }
        
        // è·å–å­—æ®µæ ‡ç­¾ - è‹±æ–‡åˆ—å¤´æ˜ å°„ä¸ºä¸­æ–‡
        function getFieldLabel(field) {
            const labels = {
                // è‹±æ–‡åˆ—å¤´æ˜ å°„
                UTC: 'åè°ƒä¸–ç•Œæ—¶',
                TimeStamp: 'æ—¶é—´æˆ³',
                flightMode: 'é£è¡Œæ¨¡å¼',
                distance: 'é£è¡Œè·ç¦» (ç±³)',
                height: 'é£è¡Œé«˜åº¦ (ç±³)',
                loseGPSAct: 'GPSä¸¢å¤±åŠ¨ä½œ',
                goHomeHeight: 'è¿”èˆªé«˜åº¦ (ç±³)',
                maxHeight: 'æœ€å¤§é«˜åº¦ (ç±³)',
                maxDistance: 'æœ€å¤§è·ç¦» (ç±³)',
                maxSpeed: 'æœ€å¤§é€Ÿåº¦ (ç±³/ç§’)',
                alt: 'æµ·æ‹”é«˜åº¦ (ç±³)',
                IMU_Sta: 'IMUçŠ¶æ€',
                lat: 'çº¬åº¦',
                lon: 'ç»åº¦',
                AutoTakeOFF: 'è‡ªåŠ¨èµ·é£',
                roll: 'æ¨ªæ»šè§’ (åº¦)',
                pitch: 'ä¿¯ä»°è§’ (åº¦)',
                yaw: 'åèˆªè§’ (åº¦)',
                motorStatus: 'ç”µæœºçŠ¶æ€',
                errorFlags: 'é”™è¯¯æ ‡å¿—',
                nsat: 'å«æ˜Ÿæ•°é‡',
                voltage: 'ç”µæ± ç”µå‹ (ä¼ç‰¹)',
                verticalSpeed: 'å‚ç›´é€Ÿåº¦ (ç±³/ç§’)',
                
                // ä¸­æ–‡åˆ—å¤´æ˜ å°„ï¼ˆä¿ç•™åŸæœ‰ï¼‰
                'è·ç¦»': 'é£è¡Œè·ç¦» (ç±³)',
                'é«˜åº¦': 'é£è¡Œé«˜åº¦ (ç±³)',
                'å‰è¿›é€Ÿåº¦': 'å‰è¿›é€Ÿåº¦ (ç±³/ç§’)',
                'ä¸Šå‡é€Ÿåº¦': 'å‚ç›´é€Ÿåº¦ (ç±³/ç§’)',
                'å«æ˜Ÿæ•°é‡': 'å«æ˜Ÿæ•°é‡',
                'æ–¹å‘': 'æ–¹å‘ (åº¦)',
                'å‰å€¾è§’': 'ä¿¯ä»°è§’ (åº¦)',
                'ç”µé‡': 'ç”µæ± ç”µé‡ (%)',
                'ç´¯è®¡é£è¡Œ': 'ç´¯è®¡é£è¡Œæ—¶é—´',
                'é£è¡Œæ¨¡å¼': 'é£è¡Œæ¨¡å¼',
                'å½“å‰æ—¶é—´': 'å½“å‰æ—¶é—´',
                'ç»åº¦': 'ç»åº¦',
                'çº¬åº¦': 'çº¬åº¦'
            };
            return labels[field] || field;
        }
        
        // å°†ç§’æ•°è½¬æ¢ä¸ºæ—¶åˆ†ç§’æ ¼å¼
        function formatFlightTime(seconds) {
            if (seconds < 0) seconds = 0;
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}æ—¶${minutes}åˆ†${secs}ç§’`;
            } else if (minutes > 0) {
                return `${minutes}åˆ†${secs}ç§’`;
            } else {
                return `${secs}ç§’`;
            }
        }
        
        // æ£€æŸ¥å­—æ®µæ˜¯å¦åº”è¯¥æ˜¾ç¤ºåœ¨å›¾è¡¨ä¸­ï¼ˆæ’é™¤ç»çº¬åº¦ï¼‰
        function shouldShowInChart(field) {
            const hiddenFields = ['lat', 'lon', 'çº¬åº¦', 'ç»åº¦'];
            return !hiddenFields.includes(field);
        }

        // è·å–å­—æ®µé¢œè‰² - å½©è™¹æ–­å±‚æ¸å˜è‰²
        function getFieldColor(field) {
            // åŠ¨æ€ç”Ÿæˆé«˜å¯¹æ¯”åº¦é¢œè‰² - åŸºäºHSVè‰²å½©ç©ºé—´
            const validFields = Object.keys(chartData.datasets).filter(f => 
                shouldShowInChart(f) && 
                chartData.datasets[f] && 
                chartData.datasets[f].length > 0
            );
            
            // æ‰¾åˆ°å½“å‰å­—æ®µåœ¨æœ‰æ•ˆå­—æ®µä¸­çš„ç´¢å¼•
            const fieldIndex = validFields.indexOf(field);
            const totalFields = validFields.length;
            
            // ä½¿ç”¨é»„é‡‘è§’åˆ†å‰²ç®—æ³•ç”Ÿæˆå‡åŒ€åˆ†å¸ƒçš„é¢œè‰²
            const goldenRatio = 0.618033988749895;
            let hue;
            
            if (fieldIndex !== -1) {
                // å‡åŒ€åˆ†å¸ƒè‰²ç›¸
                hue = (fieldIndex * goldenRatio * 360) % 360;
            } else {
                // ä½¿ç”¨å­—æ®µåå“ˆå¸Œç”Ÿæˆè‰²ç›¸
                let hash = 0;
                for (let i = 0; i < field.length; i++) {
                    hash = field.charCodeAt(i) + ((hash << 5) - hash);
                }
                hue = Math.abs(hash) % 360;
            }
            
            // æ ¹æ®æ•°æ®é‡è°ƒæ•´é¥±å’Œåº¦å’Œäº®åº¦ï¼Œç¡®ä¿å¯è¯»æ€§
            const saturation = 70 + (fieldIndex % 3) * 10; // 70-90%
            const lightness = 45 + (fieldIndex % 2) * 10;   // 45-55%
            
            // å°†HSVè½¬æ¢ä¸ºHEX
            return hslToHex(hue, saturation, lightness);
        }
        
        // HSLè½¬HEXé¢œè‰²å‡½æ•°
        function hslToHex(h, s, l) {
            h /= 360;
            s /= 100;
            l /= 100;
            
            let r, g, b;
            
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            
            const toHex = (c) => {
                const hex = Math.round(c * 255).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            };
            
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }
        
        // åŠ¨æ€ç”Ÿæˆå›¾è¡¨æŒ‰é’®
        function generateChartButtons() {
            const container = document.getElementById('dynamic-chart-buttons');
            if (!container) return;
            
            // æ¸…ç©ºç°æœ‰æŒ‰é’®ï¼ˆä¿ç•™æ˜¾ç¤ºæ‰€æœ‰æ•°æ®æŒ‰é’®ï¼‰
            const existingButtons = container.querySelectorAll('.chart-btn[data-field]');
            existingButtons.forEach(btn => btn.remove());
            
            // è·å–æ‰€æœ‰æ•°æ®åˆ—
            const fields = Object.keys(chartData.datasets);
            if (fields.length === 0) return;
            
            // åœ¨æ˜¾ç¤ºæ‰€æœ‰æ•°æ®æŒ‰é’®å‰æ’å…¥åŠ¨æ€æŒ‰é’®
            const showAllBtn = document.getElementById('show-all-data');
            
            fields.forEach(field => {
                // è·³è¿‡ç»çº¬åº¦å­—æ®µ
                if (!shouldShowInChart(field)) {
                    return;
                }
                
                if (chartData.datasets[field] && chartData.datasets[field].length > 0) {
                    const button = document.createElement('button');
                    button.className = 'chart-btn';
                    button.setAttribute('data-field', field);
                    button.textContent = getFieldLabel(field); // ä½¿ç”¨ä¸­æ–‡æ ‡ç­¾
                    button.style.display = 'inline-block';
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    button.addEventListener('click', function() {
                        const allButtons = container.querySelectorAll('.chart-btn');
                        allButtons.forEach(btn => {
                            btn.classList.remove('active');
                            btn.style.backgroundColor = ''; // æ¢å¤é»˜è®¤èƒŒæ™¯è‰²
                        });
                        
                        // é‡ç½®å·²ä¿å­˜ç»„åˆæŒ‰é’®çš„æ ·å¼
                        resetCombinationButtons();
                        
                        this.classList.add('active');
                        this.style.backgroundColor = '#8593ab'; // è®¾ç½®ç‚¹å‡»æŒ‰é’®çš„èƒŒæ™¯è‰²
                        updateChart(field);
                    });
                    
                    // æ’å…¥åˆ°æ˜¾ç¤ºæ‰€æœ‰æ•°æ®æŒ‰é’®ä¹‹å‰
                    container.insertBefore(button, showAllBtn);
                }
            });
        }
        
        // æ ¹æ®å®é™…æ•°æ®æƒ…å†µæ˜¾ç¤º/éšè—å›¾è¡¨æŒ‰é’®
        function updateChartButtonsVisibility() {
            // é‡æ–°ç”Ÿæˆå›¾è¡¨æŒ‰é’®
            generateChartButtons();
            
            // å¦‚æœæ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            const fields = Object.keys(chartData.datasets);
            const hasValidData = fields.some(field => 
                chartData.datasets[field] && 
                chartData.datasets[field].length > 0 && 
                chartData.datasets[field].some(v => v !== 0 && v !== null)
            );
            
            if (!hasValidData && fields.length > 0) {
                showToast('å½“å‰æ—¥å¿—æ–‡ä»¶ä¸­æ²¡æœ‰å¯ç”¨çš„å›¾è¡¨æ•°æ®');
            }
        }
        
        // å¤„ç†æ ¼å¼2å’Œæ ¼å¼4çš„å›¾è¡¨æ•°æ®ï¼ˆç®€åŒ–å¤„ç†ï¼‰
        function processFormat2ChartData(lines) {
            processGenericChartData(lines, ',');
        }
        
        function processFormat4ChartData(lines) {
            processGenericChartData(lines, ',');
        }
        
        // å¤„ç†æ‰€æœ‰æ ¼å¼çš„å›¾è¡¨æ•°æ®
        function processAllChartData(lines, formatType) {
            let headers = [];
            let delimiter = ',';
            
            // æ ¹æ®æ ¼å¼ç±»å‹ç¡®å®šåˆ†éš”ç¬¦å’Œè¡¨å¤´å¤„ç†æ–¹å¼
            let fileHeaders = [];
            if (formatType === 'format1' || formatType === 'format3') {
                delimiter = 'â”‡';
                fileHeaders = lines[0].split(delimiter).map(h => h.trim()).filter(h => h !== '');
            } else {
                delimiter = ',';
                fileHeaders = lines[0].split(delimiter).map(h => h.trim());
            }
            
            
            
            // åŠ¨æ€è§£ææ—¥å¿—æ–‡ä»¶ï¼Œåˆ›å»ºäºŒç»´æ•°ç»„æ•°æ®ç»“æ„
            const dataMatrix = [];
            
            // åˆ›å»ºä»¥åˆ—å¤´ä¸ºé”®çš„æ•°æ®å¯¹è±¡
            const columnData = {};
            fileHeaders.forEach(header => {
                columnData[header] = [];
            });
            
            // è§£ææ•°æ®è¡Œï¼Œå¡«å……äºŒç»´æ•°ç»„å’Œåˆ—æ•°æ®
            let validRows = 0;
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') {
                    continue;
                }
                
                let columns = [];
                if (formatType === 'format1' || formatType === 'format3') {
                    columns = lines[i].split(delimiter).map(c => c.trim()).filter(c => c !== '');
                } else {
                    columns = lines[i].split(delimiter).map(c => c.trim());
                }
                
                if (columns.length < fileHeaders.length) {
                    continue;
                }
                
                validRows++;
                // æ·»åŠ åˆ°äºŒç»´æ•°ç»„
                dataMatrix.push(columns);
                
                // æŒ‰åˆ—ç»„ç»‡æ•°æ®
                columns.forEach((value, index) => {
                    if (index < fileHeaders.length) {
                        const header = fileHeaders[index];
                        columnData[header].push(value);
                    }
                });
            }
            

            
            // ä½¿ç”¨åŠ¨æ€è§£æçš„æ•°æ®åˆ›å»ºå›¾è¡¨
            if (dataMatrix.length > 0) {
                // ä½¿ç”¨æ—¶é—´åˆ—ä½œä¸ºæ ‡ç­¾ï¼ˆç¬¬ä¸€åˆ—é€šå¸¸æ˜¯æ—¶é—´æˆ–åºå·ï¼‰
                const timeColumn = columnData[fileHeaders[0]] || [];
                chartData.labels = timeColumn.map((time, index) => time || `ç‚¹${index + 1}`);
                
                // ä¸ºæ¯ä¸€åˆ—åˆ›å»ºæ•°æ®é›†
                fileHeaders.forEach((header, columnIndex) => {
                    if (columnIndex === 0) return; // è·³è¿‡ç¬¬ä¸€åˆ—ï¼ˆæ—¶é—´åˆ—ï¼‰
                    
                    // è·³è¿‡ç»çº¬åº¦å­—æ®µ
                    if (!shouldShowInChart(header)) {
                        return;
                    }
                    
                    const columnValues = columnData[header];
                    
                    const numericValues = columnValues.map(value => {
                        if (!value) return 0;
                        
                        let numericValue = 0;
                        
                        // å¤„ç†æ—¶é—´æ ¼å¼ï¼ˆHH:MM:SSï¼‰
                        if (value.includes(':')) {
                            const timeParts = value.split(':');
                            if (timeParts.length === 3) {
                                numericValue = parseInt(timeParts[0]) * 3600 + 
                                             parseInt(timeParts[1]) * 60 + 
                                             parseInt(timeParts[2]);
                            } else {
                                numericValue = parseFloat(value.replace(/[^0-9.-]/g, '')) || 0;
                            }
                        } else {
                            // æ™®é€šæ•°å­—æ ¼å¼
                            numericValue = parseFloat(value.replace(/[^0-9.-]/g, '')) || 0;
                        }
                        
                        return numericValue;
                    });
                    
                    // ä½¿ç”¨åˆ—å¤´ä½œä¸ºå­—æ®µåï¼Œä¿ç•™ä¸­æ–‡
                    const fieldName = header.trim();
                    addToDataset(fieldName, numericValues);
                });
            }
            
            // æ•°æ®åŠ è½½å®Œæˆåï¼ŒåŠ¨æ€ç”Ÿæˆå›¾è¡¨æŒ‰é’®å¹¶æ˜¾ç¤ºå›¾è¡¨
            generateChartButtons();
            updateChartButtonsVisibility();
            
            // å¦‚æœæœ‰æ•°æ®ï¼Œè‡ªåŠ¨æ˜¾ç¤ºå›¾è¡¨
            const hasData = Object.values(chartData.datasets).some(dataset => dataset && dataset.length > 0);
            if (hasData) {
                showAllDataItems();
            }
        }
        
        // å¤„ç†æ ¼å¼2å’Œæ ¼å¼4çš„å›¾è¡¨æ•°æ®
        function processFormat2ChartData(lines) {
            processAllChartData(lines, 'format2');
        }
        
        function processFormat4ChartData(lines) {
            processAllChartData(lines, 'format4');
        }
        
        function processGenericChartData(lines, delimiter) {
            processAllChartData(lines, 'format2');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–DOMå…ƒç´ 
            const fileInput = document.getElementById('file-input');
            const uploadBtn = document.getElementById('upload-btn');
            const fileListContainer = document.getElementById('file-list-container');
            const tableLoading = document.getElementById('table-loading');
            const logTable = document.getElementById('log-table');
            const tableHeader = document.getElementById('table-header');
            const tableBody = document.getElementById('table-body');
            const menuBtn = document.getElementById('menu-btn');
            const fileList = document.getElementById('file-list');
            const overlay = document.getElementById('overlay');
            const kmlExportBtn = document.getElementById('kml-export-btn');
            
            // åˆå§‹åŒ–å›¾è¡¨
            initChart();
            
            // åˆå§‹åŒ–å›¾è¡¨å¤§å°å˜åŒ–å¤„ç†å™¨
            initChartResizeHandler();
            
            // åˆå§‹åŒ–æ ‡ç­¾é¡µ
            initTabs();
            
            // åˆå§‹åŒ–é“¾æ¥çŠ¶æ€
            const longitudeElem = document.getElementById('longitude-value');
            const latitudeElem = document.getElementById('latitude-value');
            longitudeElem.removeAttribute('href');
            latitudeElem.removeAttribute('href');
            
            // ç»‘å®šå›¾è¡¨æŒ‰é’®äº‹ä»¶
            const chartButtons = document.querySelectorAll('.chart-btn');
            chartButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
                    chartButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // è®¾ç½®å½“å‰æŒ‰é’®ä¸ºæ¿€æ´»çŠ¶æ€
                    this.classList.add('active');
                    
                    // è·å–æ•°æ®å­—æ®µ
                    const field = this.getAttribute('data-field');
                    
                    // æ›´æ–°å›¾è¡¨æ˜¾ç¤º
                    updateChart(field);
                });
            });
            
            // ç»‘å®šæ˜¾ç¤ºæ‰€æœ‰æ•°æ®æŒ‰é’®äº‹ä»¶
            const showAllDataBtn = document.getElementById('show-all-data');
            showAllDataBtn.addEventListener('click', function() {
                // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€å’ŒèƒŒæ™¯è‰²
                chartButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.backgroundColor = '';
                });
                
                // é‡ç½®å·²ä¿å­˜ç»„åˆæŒ‰é’®çš„æ ·å¼
                resetCombinationButtons();
                
                // è®¾ç½®å½“å‰æŒ‰é’®ä¸ºæ¿€æ´»çŠ¶æ€å’ŒèƒŒæ™¯è‰²
                this.classList.add('active');
                this.style.backgroundColor = '#8593ab';
                
                // æ˜¾ç¤ºæ‰€æœ‰æ•°æ®é¡¹
                showAllDataItems();
            });
            
            // ç§»åŠ¨ç«¯èœå•æ§åˆ¶
            menuBtn.addEventListener('click', function() {
                fileList.classList.toggle('active');
                overlay.classList.toggle('active');
            });
            
            overlay.addEventListener('click', function() {
                fileList.classList.remove('active');
                overlay.classList.remove('active');
            });
            
            // ç»‘å®šKMLå¯¼å‡ºæŒ‰é’®äº‹ä»¶
            kmlExportBtn.addEventListener('click', downloadKML);
            
            // ç»‘å®šäº‹ä»¶
            uploadBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            // åŒå‡»æ–‡ä»¶åˆ—è¡¨åŒºåŸŸæ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
            fileListContainer.addEventListener('dblclick', function(e) {
                if (!e.target.classList.contains('file-item') && 
                    !e.target.closest('.file-item')) {
                    fileInput.click();
                }
            });
            
            fileInput.addEventListener('change', function(e) {
                const files = e.target.files;
                if (files.length === 0) return;
                
                // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
                fileListContainer.innerHTML = '';
                
                // æ·»åŠ æ–‡ä»¶åˆ°åˆ—è¡¨
                Array.from(files).forEach(file => {
                    if (!file.name.match(/\.(log)$/i)) {
                        showToast('è¯·é€‰æ‹©.logæ ¼å¼çš„æ–‡ä»¶');
                        return;
                    }
                    
                    const fileElement = document.createElement('div');
                    fileElement.className = 'file-item';
                    fileElement.innerHTML = `
                        <div class="file-name">${file.name}</div>
                        <div class="file-date">${new Date(file.lastModified).toLocaleString()}</div>
                    `;
                    
                    fileElement.addEventListener('click', function() {
                        // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                        document.querySelectorAll('.file-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        // è®¾ç½®å½“å‰æ¿€æ´»çŠ¶æ€
                        fileElement.classList.add('active');
                        
                        // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šé€‰æ‹©æ–‡ä»¶åå…³é—­èœå•
                        if (window.innerWidth <= 767) {
                            fileList.classList.remove('active');
                            overlay.classList.remove('active');
                        }
                        
                        // å¯ç”¨KMLå¯¼å‡ºæŒ‰é’®
                        kmlExportBtn.removeAttribute('disabled');
                        
                        // è¯»å–æ–‡ä»¶
                        readLogFile(file);
                    });
                    
                    fileListContainer.appendChild(fileElement);
                });
                
                // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªæ–‡ä»¶
                if (fileListContainer.querySelectorAll('.file-item').length > 0) {
                    fileListContainer.querySelector('.file-item').click();
                }
            });

            // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶å¤„ç† - ä¼˜åŒ–å›¾è¡¨è§¦æ‘¸æ”¯æŒ
            function initTouchEvents() {
                const chartCanvas = document.getElementById('data-chart');
                const chartContainer = document.querySelector('.chart-container');
                
                if (chartCanvas && chartContainer) {
                    // ç§»é™¤å¯èƒ½å¹²æ‰°çš„é»˜è®¤äº‹ä»¶å¤„ç†
                    chartCanvas.addEventListener('touchstart', function(e) {
                        // å…è®¸å›¾è¡¨å¤„ç†æ‰€æœ‰è§¦æ‘¸äº‹ä»¶
                        e.stopPropagation();
                    }, { passive: true });

                    chartCanvas.addEventListener('touchmove', function(e) {
                        // å…è®¸å›¾è¡¨å¤„ç†æ‰€æœ‰è§¦æ‘¸ç§»åŠ¨äº‹ä»¶
                        e.stopPropagation();
                    }, { passive: true });
                    
                    // æ·»åŠ å¯¹å›¾è¡¨å®¹å™¨çš„è§¦æ‘¸æ”¯æŒ
                    chartContainer.addEventListener('touchstart', function(e) {
                        // å…è®¸å®¹å™¨å¤„ç†è§¦æ‘¸äº‹ä»¶
                        e.stopPropagation();
                    }, { passive: true });

                    chartContainer.addEventListener('touchmove', function(e) {
                        // å…è®¸å®¹å™¨å¤„ç†è§¦æ‘¸ç§»åŠ¨äº‹ä»¶
                        e.stopPropagation();
                    }, { passive: true });
                    
                    // é˜²æ­¢é¡µé¢æ»šåŠ¨å¹²æ‰°å›¾è¡¨æ“ä½œ
                    chartContainer.addEventListener('touchmove', function(e) {
                        if (e.touches.length > 1) {
                            // å¤šæŒ‡æ“ä½œæ—¶é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆç¼©æ”¾ï¼‰
                            e.preventDefault();
                        }
                    }, { passive: false });
                }
            }
            
            // åˆå§‹åŒ–è§¦æ‘¸äº‹ä»¶
            initTouchEvents();
            
            // é‡æ–°ç»‘å®šå›¾è¡¨æŒ‰é’®äº‹ä»¶ï¼Œç¡®ä¿è§¦æ‘¸æ”¯æŒ
            const touchChartButtons = document.querySelectorAll('.chart-btn');
            touchChartButtons.forEach(button => {
                // æ·»åŠ è§¦æ‘¸å‹å¥½çš„æ ·å¼ç±»
                button.classList.add('touch-friendly');
            });
            
            // ä¸ºæ‰€æœ‰è®¾å¤‡æ·»åŠ é‡ç½®ç¼©æ”¾æŒ‰é’®äº‹ä»¶ç»‘å®š
            const resetZoomBtn = document.getElementById('reset-zoom-btn');
            if (resetZoomBtn) {
                resetZoomBtn.style.display = 'block';
                resetZoomBtn.addEventListener('click', function() {
                    if (dataChart && dataChart.resetZoom) {
                        dataChart.resetZoom();
                        showToast('å·²é‡ç½®è§†å›¾');
                    }
                });
            }

            // åˆ›å»ºé•¿æŒ‰è¿ç»­è§¦å‘åŠŸèƒ½
            function setupContinuousAction(element, action, interval = 100) {
                let isPressed = false;
                let intervalId = null;
                
                const startAction = function() {
                    if (isPressed) return;
                    isPressed = true;
                    
                    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
                    action();
                    
                    // å¼€å§‹è¿ç»­è§¦å‘
                    intervalId = setInterval(() => {
                        if (isPressed) {
                            action();
                        }
                    }, interval);
                };
                
                const stopAction = function() {
                    isPressed = false;
                    if (intervalId) {
                        clearInterval(intervalId);
                        intervalId = null;
                    }
                };
                
                // é¼ æ ‡äº‹ä»¶
                element.addEventListener('mousedown', startAction);
                element.addEventListener('mouseup', stopAction);
                element.addEventListener('mouseleave', stopAction);
                
                // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯æ”¯æŒï¼‰
                element.addEventListener('touchstart', function(e) {
                    e.preventDefault(); // é˜²æ­¢æ»šåŠ¨
                    startAction();
                });
                element.addEventListener('touchend', stopAction);
                element.addEventListener('touchcancel', stopAction);
                
                // é˜²æ­¢å³é”®èœå•
                element.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                });
            }
            
            // ç»‘å®šç¼©æ”¾å’Œç§»åŠ¨æŒ‰é’®äº‹ä»¶ï¼ˆæ”¯æŒé•¿æŒ‰è¿ç»­è§¦å‘ï¼‰
            const zoomInBtn = document.getElementById('zoom-in-btn');
            const zoomOutBtn = document.getElementById('zoom-out-btn');
            const panLeftBtn = document.getElementById('pan-left-btn');
            const panRightBtn = document.getElementById('pan-right-btn');
            
            if (zoomInBtn) {
                setupContinuousAction(zoomInBtn, function() {
                    if (dataChart && dataChart.zoom) {
                        dataChart.zoom(1.05); // å‡å°æ­¥é•¿ï¼Œæ›´å¹³æ»‘
                    }
                }, 150);
            }
            
            if (zoomOutBtn) {
                setupContinuousAction(zoomOutBtn, function() {
                    if (dataChart && dataChart.zoom) {
                        dataChart.zoom(0.95); // å‡å°æ­¥é•¿ï¼Œæ›´å¹³æ»‘
                    }
                }, 150);
            }
            
            if (panLeftBtn) {
                setupContinuousAction(panLeftBtn, function() {
                    if (dataChart && dataChart.pan) {
                        dataChart.pan({x: -20}); // å‡å°æ­¥é•¿ï¼Œæ›´å¹³æ»‘
                    }
                }, 100);
            }
            
            if (panRightBtn) {
                setupContinuousAction(panRightBtn, function() {
                    if (dataChart && dataChart.pan) {
                        dataChart.pan({x: 20}); // å‡å°æ­¥é•¿ï¼Œæ›´å¹³æ»‘
                    }
                }, 100);
            }
            
            // æ·»åŠ ä¸Šä¸‹ç§»åŠ¨æŒ‰é’®äº‹ä»¶ç»‘å®šï¼ˆæ”¯æŒé•¿æŒ‰è¿ç»­è§¦å‘ï¼‰
            const panUpBtn = document.getElementById('pan-up-btn');
            const panDownBtn = document.getElementById('pan-down-btn');
            
            if (panUpBtn) {
                setupContinuousAction(panUpBtn, function() {
                    if (dataChart && dataChart.pan) {
                        dataChart.pan({y: -20}); // å‡å°æ­¥é•¿ï¼Œæ›´å¹³æ»‘
                    }
                }, 100);
            }
            
            if (panDownBtn) {
                setupContinuousAction(panDownBtn, function() {
                    if (dataChart && dataChart.pan) {
                        dataChart.pan({y: 20}); // å‡å°æ­¥é•¿ï¼Œæ›´å¹³æ»‘
                    }
                }, 100);
            }
            
            // è¯»å–æ—¥å¿—æ–‡ä»¶
            function readLogFile(file) {
                tableLoading.style.display = 'block';
                logTable.style.display = 'none';
                
                // å­˜å‚¨å½“å‰æ–‡ä»¶å
                currentLogFileName = file.name;
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const logData = e.target.result;
                        // å­˜å‚¨åŸå§‹æ—¥å¿—æ•°æ®
                        currentLogData = logData.split('\n').filter(line => line.trim() !== '');
                        parseLogData(logData, file.name);
                    } catch (error) {
                        tableLoading.innerHTML = "æ–‡ä»¶è¯»å–é”™è¯¯: " + error.message;
                        // æ˜¾ç¤ºé”™è¯¯æç¤º
                    }
                };
                
                reader.onerror = function() {
                    tableLoading.innerHTML = "æ— æ³•è¯»å–æ–‡ä»¶";
                };
                
                reader.readAsText(file);
            }
            
            // è§£ææ—¥å¿—æ•°æ®
            function parseLogData(logData, fileName) {
                const lines = logData.split('\n').filter(line => line.trim() !== '');
                
                // æ£€æµ‹æ—¥å¿—æ ¼å¼å¹¶æå–è¡¨æ ¼éƒ¨åˆ†
                let tableLines = extractTableLines(lines);
                
                if (tableLines.length === 0) {
                    tableLoading.innerHTML = "æœªæ‰¾åˆ°è¡¨æ ¼æ•°æ®";
                    return;
                }
                
                // æ£€æµ‹æ—¥å¿—æ ¼å¼
                let formatType = detectLogFormat(tableLines);
                
                if (formatType === 'format1') {
                    parseFormat1(tableLines);
                } else if (formatType === 'format2') {
                    parseFormat2(tableLines);
                } else if (formatType === 'format3') {
                    parseFormat3(tableLines);
                } else if (formatType === 'format4') {
                    parseFormat4(tableLines);
                } else {
                    tableLoading.innerHTML = "æ— æ³•è¯†åˆ«çš„æ—¥å¿—æ ¼å¼";
                    return;
                }
                
                // æ˜¾ç¤ºè¡¨æ ¼
                tableLoading.style.display = 'none';
                logTable.style.display = 'table';
            }
            
            // è§£æç¬¬ä¸€ç§æ—¥å¿—æ ¼å¼
            function parseFormat1(lines) {
                // ç¬¬ä¸€è¡Œæ˜¯è¡¨å¤´
                const headers = lines[0].split('â”‡').map(h => h.trim()).filter(h => h !== '');
                
                // åˆ›å»ºè¡¨å¤´
                tableHeader.innerHTML = '';
                const headerRow = document.createElement('tr');
                
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    
                    // æ ¹æ®å†…å®¹æ·»åŠ æ ·å¼ç±»
                    if (header.includes('è·ç¦»')) th.className = 'col-distance';
                    else if (header.includes('é«˜åº¦')) th.className = 'col-height';
                    else if (header.includes('ç»åº¦')) th.className = 'col-longitude';
                    else if (header.includes('çº¬åº¦')) th.className = 'col-latitude';
                    else if (header.includes('èˆªé€Ÿ')) th.className = 'col-speed';
                    else if (header.includes('å‡é€Ÿ')) th.className = 'col-vertical-speed';
                    else if (header.includes('å«æ˜Ÿ')) th.className = 'col-satellites';
                    else if (header.includes('æ–¹å‘')) th.className = 'col-direction';
                    else if (header.includes('å€¾è§’')) th.className = 'col-angle';
                    else if (header.includes('ç”µé‡')) th.className = 'col-battery';
                    else if (header.includes('é£è¡Œ')) th.className = 'col-flight-time';
                    else if (header.includes('æ—¶é—´')) th.className = 'col-time';
                    
                    headerRow.appendChild(th);
                });
                
                tableHeader.appendChild(headerRow);
                
                // è§£ææ•°æ®è¡Œ
                tableBody.innerHTML = '';
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const columns = lines[i].split('â”‡').map(c => c.trim());
                    if (columns.length < headers.length + 1) continue;
                    
                    const row = document.createElement('tr');
                    
                    // è·³è¿‡ç¬¬ä¸€ä¸ªç©ºåˆ—ï¼ˆç”±äºåˆ†éš”ç¬¦åœ¨å¼€å¤´ï¼‰
                    for (let j = 1; j < headers.length + 1; j++) {
                        const td = document.createElement('td');
                        td.textContent = columns[j] || '-';
                        
                        // ä¸ºæ•°æ®å•å…ƒæ ¼æ·»åŠ ä¸è¡¨å¤´ç›¸åŒçš„ç±»
                        const headerClass = headerRow.children[j-1].className;
                        if (headerClass) {
                            td.className = headerClass;
                        }
                        
                        row.appendChild(td);
                    }
                    
                    tableBody.appendChild(row);
                }
                
                // è®¡ç®—å¹¶æ˜¾ç¤ºç‰¹å®šæ•°æ®
                calculateSpecialData(lines, 0, 'format1');
                
                // å¤„ç†å›¾è¡¨æ•°æ®
                processChartData(lines, 'format1');
            }
            
            // è§£æç¬¬äºŒç§æ—¥å¿—æ ¼å¼
            function parseFormat2(lines) {
                // ç¬¬ä¸€è¡Œæ˜¯è¡¨å¤´
                const headers = lines[0].split(',').map(h => h.trim());
                
                // åˆ›å»ºè¡¨å¤´
                tableHeader.innerHTML = '';
                const headerRow = document.createElement('tr');
                
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    
                    // æ ¹æ®å†…å®¹æ·»åŠ æ ·å¼ç±»
                    if (header.includes('è·ç¦»')) th.className = 'col-distance';
                    else if (header.includes('é«˜åº¦')) th.className = 'col-height';
                    else if (header.includes('ç»åº¦')) th.className = 'col-longitude';
                    else if (header.includes('çº¬åº¦')) th.className = 'col-latitude';
                    else if (header.includes('é€Ÿåº¦')) th.className = 'col-speed';
                    else if (header.includes('å«æ˜Ÿ')) th.className = 'col-satellites';
                    else if (header.includes('æ–¹å‘') || header.includes('èˆªå‘')) th.className = 'col-direction';
                    else if (header.includes('å€¾è§’') || header.includes('ä¾§å€¾') || header.includes('ä¿¯ä»°')) th.className = 'col-angle';
                    else if (header.includes('ç”µå‹') || header.includes('ç”µé‡')) th.className = 'col-battery';
                    else if (header.includes('æ—¶é—´')) th.className = 'col-time';
                    else if (header.includes('é£è¡Œ')) th.className = 'col-flight-time';
                    
                    headerRow.appendChild(th);
                });
                
                tableHeader.appendChild(headerRow);
                
                // è§£ææ•°æ®è¡Œ
                tableBody.innerHTML = '';
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const columns = lines[i].split(',').map(c => c.trim());
                    if (columns.length < headers.length) continue;
                    
                    const row = document.createElement('tr');
                    
                    columns.forEach((column, index) => {
                        const td = document.createElement('td');
                        td.textContent = column || '-';
                        
                        // ä¸ºæ•°æ®å•å…ƒæ ¼æ·»åŠ ä¸è¡¨å¤´ç›¸åŒçš„ç±»
                        const headerClass = headerRow.children[index].className;
                        if (headerClass) {
                            td.className = headerClass;
                        }
                        
                        row.appendChild(td);
                    });
                    
                    tableBody.appendChild(row);
                }
                
                // è®¡ç®—å¹¶æ˜¾ç¤ºç‰¹å®šæ•°æ®
                calculateSpecialData(lines, 0, 'format2');
                
                // å¤„ç†å›¾è¡¨æ•°æ®
                processChartData(lines, 'format2');
            }
            
            // è§£æç¬¬ä¸‰ç§æ—¥å¿—æ ¼å¼
            function parseFormat3(lines) {
                // ç¬¬ä¸€è¡Œæ˜¯è¡¨å¤´ï¼Œä½†éœ€è¦ç‰¹æ®Šå¤„ç†
                const headerLine = lines[0];
                // æŒ‰ç«–çº¿åˆ†å‰²å¹¶è¿‡æ»¤ç©ºå€¼
                let headers = headerLine.split('â”‡').map(h => h.trim()).filter(h => h !== '');
                
                // å¤„ç†è¡¨å¤´ä¸­çš„ç‰¹æ®Šå­—ç¬¦
                headers = headers.map(header => {
                    if (header.includes('â†') && header.includes('â†’')) {
                        return 'å½“å‰æ—¶é—´';
                    }
                    return header;
                });
                
                // åˆ›å»ºè¡¨å¤´
                tableHeader.innerHTML = '';
                const headerRow = document.createElement('tr');
                
                // æŸ¥æ‰¾ç´¯è®¡é£è¡Œæ—¶é—´åˆ—çš„ç´¢å¼•
                let cumulativeFlightTimeIndex = -1;
                
                headers.forEach((header, index) => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    
                    // æ ¹æ®å†…å®¹æ·»åŠ æ ·å¼ç±»
                    if (header.includes('æ—¶é—´')) th.className = 'col-time';
                    else if (header.includes('è·ç¦»')) th.className = 'col-distance';
                    else if (header.includes('é«˜åº¦')) th.className = 'col-height';
                    else if (header.includes('ç»åº¦')) th.className = 'col-longitude';
                    else if (header.includes('çº¬åº¦')) th.className = 'col-latitude';
                    else if (header.includes('å‰è¿›é€Ÿåº¦')) th.className = 'col-speed';
                    else if (header.includes('ä¸Šå‡é€Ÿåº¦')) th.className = 'col-vertical-speed';
                    else if (header.includes('å«æ˜Ÿ')) th.className = 'col-satellites';
                    else if (header.includes('æ–¹å‘')) th.className = 'col-direction';
                    else if (header.includes('å€¾è§’')) th.className = 'col-angle';
                    else if (header.includes('ç”µé‡')) th.className = 'col-battery';
                    else if (header.includes('é£è¡Œ')) th.className = 'col-flight-time';
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºç´¯è®¡é£è¡Œæ—¶é—´åˆ—
                    if (header.includes('ç´¯è®¡é£è¡Œ')) {
                        cumulativeFlightTimeIndex = index;
                    }
                    
                    headerRow.appendChild(th);
                });
                
                tableHeader.appendChild(headerRow);
                
                // è§£ææ•°æ®è¡Œ
                tableBody.innerHTML = '';
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    // æŒ‰ç«–çº¿åˆ†å‰²å¹¶è¿‡æ»¤ç©ºå€¼
                    const columns = lines[i].split('â”‡').map(c => c.trim()).filter(c => c !== '');
                    if (columns.length < headers.length) continue;
                    
                    const row = document.createElement('tr');
                    
                    columns.forEach((column, index) => {
                        const td = document.createElement('td');
                        td.textContent = column || '-';
                        
                        // ä¸ºæ•°æ®å•å…ƒæ ¼æ·»åŠ ä¸è¡¨å¤´ç›¸åŒçš„ç±»
                        const headerClass = headerRow.children[index].className;
                        if (headerClass) {
                            td.className = headerClass;
                        }
                        
                        row.appendChild(td);
                    });
                    
                    tableBody.appendChild(row);
                }
                
                // è®¡ç®—å¹¶æ˜¾ç¤ºç‰¹å®šæ•°æ®
                calculateSpecialData(lines, 0, 'format3', cumulativeFlightTimeIndex);
                
                // å¤„ç†å›¾è¡¨æ•°æ®
                processChartData(lines, 'format3');
            }
            
            // è§£æç¬¬å››ç§æ—¥å¿—æ ¼å¼
            function parseFormat4(lines) {
                // ç¬¬ä¸€è¡Œæ˜¯è¡¨å¤´
                const headers = lines[0].split(',').map(h => h.trim());
                
                // åˆ›å»ºè¡¨å¤´
                tableHeader.innerHTML = '';
                const headerRow = document.createElement('tr');
                
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    
                    // æ ¹æ®å†…å®¹æ·»åŠ æ ·å¼ç±»
                    if (header.includes('è·ç¦»')) th.className = 'col-distance';
                    else if (header.includes('é«˜åº¦')) th.className = 'col-height';
                    else if (header.includes('ç»åº¦')) th.className = 'col-longitude';
                    else if (header.includes('çº¬åº¦')) th.className = 'col-latitude';
                    else if (header.includes('é€Ÿåº¦')) th.className = 'col-speed';
                    else if (header.includes('å«æ˜Ÿ')) th.className = 'col-satellites';
                    else if (header.includes('æ–¹å‘') || header.includes('èˆªå‘')) th.className = 'col-direction';
                    else if (header.includes('å€¾è§’') || header.includes('ä¾§å€¾') || header.includes('ä¿¯ä»°')) th.className = 'col-angle';
                    else if (header.includes('ç”µå‹') || header.includes('ç”µé‡')) th.className = 'col-battery';
                    else if (header.includes('æ—¶é—´')) th.className = 'col-time';
                    else if (header.includes('é£è¡Œ')) th.className = 'col-flight-time';
                    
                    headerRow.appendChild(th);
                });
                
                tableHeader.appendChild(headerRow);
                
                // è§£ææ•°æ®è¡Œ
                tableBody.innerHTML = '';
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const columns = lines[i].split(',').map(c => c.trim());
                    if (columns.length < headers.length) continue;
                    
                    const row = document.createElement('tr');
                    
                    columns.forEach((column, index) => {
                        const td = document.createElement('td');
                        td.textContent = column || '-';
                        
                        // ä¸ºæ•°æ®å•å…ƒæ ¼æ·»åŠ ä¸è¡¨å¤´ç›¸åŒçš„ç±»
                        const headerClass = headerRow.children[index].className;
                        if (headerClass) {
                            td.className = headerClass;
                        }
                        
                        row.appendChild(td);
                    });
                    
                    tableBody.appendChild(row);
                }
                
                // è®¡ç®—å¹¶æ˜¾ç¤ºç‰¹å®šæ•°æ®
                calculateSpecialData(lines, 0, 'format4');
                
                // å¤„ç†å›¾è¡¨æ•°æ®
                processChartData(lines, 'format4');
            }
            
            // è®¡ç®—ç‰¹å®šæ•°æ®
            function calculateSpecialData(lines, headerIndex, format = 'format1', cumulativeFlightTimeIndex = -1) {
                if (lines.length < headerIndex + 2) return;
                
                // é‡ç½®æ‘˜è¦æ•°æ®
                document.getElementById('longitude-value').textContent = '-';
                document.getElementById('latitude-value').textContent = '-';
                document.getElementById('flight-time-value').textContent = '-';
                document.getElementById('prev-distance-value').textContent = '-';
                document.getElementById('max-height-value').textContent = '-';
                document.getElementById('max-distance-value').textContent = '-';
                
                // åˆå§‹åŒ–é“¾æ¥çŠ¶æ€
                const longitudeElem = document.getElementById('longitude-value');
                const latitudeElem = document.getElementById('latitude-value');
                longitudeElem.removeAttribute('href');
                latitudeElem.removeAttribute('href');
                
                // è®¡ç®—é£è¡Œæ—¶é—´ï¼ˆé‡æ„åçš„é€»è¾‘ï¼‰
                let flightDuration = calculateFlightTime(lines, headerIndex, format, cumulativeFlightTimeIndex);
                document.getElementById('flight-time-value').textContent = flightDuration;
                
                if (format === 'format1') {
                    // æ£€æŸ¥ç´¯è®¡é£è¡Œæ—¶é—´æ˜¯å¦ä¸€ç›´ä¸º00:00:00
                    let allZeroFlightTime = true;
                    let lastLineWithData = null;
                    
                    for (let i = headerIndex + 1; i < lines.length; i++) {
                        if (lines[i].trim() === '') continue;
                        
                        const columns = lines[i].split('â”‡').map(c => c.trim());
                        if (columns.length < 12) continue;
                        
                        const flightTime = columns[11]; // ç´¯è®¡é£è¡Œæ—¶é—´åœ¨ç¬¬12åˆ—
                        lastLineWithData = columns;
                        
                        if (flightTime !== '00:00:00' && flightTime !== '0' && flightTime !== '0.0') {
                            allZeroFlightTime = false;
                            break;
                        }
                    }
                    
                    // å¦‚æœé£è¡Œæ—¶é—´ä¸€ç›´ä¸º00:00:00ï¼Œä½¿ç”¨æœ€åä¸€è¡Œçš„ç»çº¬åº¦
                    if (allZeroFlightTime && lastLineWithData) {
                        document.getElementById('longitude-value').textContent = lastLineWithData[3] || '-';
                        document.getElementById('latitude-value').textContent = lastLineWithData[4] || '-';
                        document.getElementById('flight-time-value').textContent = '00:00:00';
                        
                        // è·å–ä¸Šä¸€è¡Œçš„è·ç¦»æ•°æ®
                        let prevDistance = "N/A";
                        if (lines.length > headerIndex + 2) {
                            const prevColumns = lines[lines.length - 2].split('â”‡').map(c => c.trim());
                            if (prevColumns.length >= 2) {
                                prevDistance = prevColumns[1];
                            }
                        }
                        document.getElementById('prev-distance-value').textContent = prevDistance;
                    } else {
                        // å¯»æ‰¾é£è¡Œæ—¶é—´è¿ç»­ä¸åŠ¨çš„ç¬¬ä¸€è¡Œ
                        let stopIndex = -1;
                        let prevFlightTime = "";
                        
                        for (let i = lines.length - 1; i >= headerIndex + 1; i--) {
                            if (lines[i].trim() === '') continue;
                            
                            const columns = lines[i].split('â”‡').map(c => c.trim());
                            if (columns.length < 12) continue;
                            
                            const flightTime = columns[11]; // ç´¯è®¡é£è¡Œæ—¶é—´åœ¨ç¬¬12åˆ—
                            
                            if (prevFlightTime === "" || flightTime === prevFlightTime) {
                                prevFlightTime = flightTime;
                                stopIndex = i;
                            } else {
                                break;
                            }
                        }
                        
                        if (stopIndex !== -1) {
                            const stopColumns = lines[stopIndex].split('â”‡').map(c => c.trim());
                            
                            // è·å–ä¸Šä¸€è¡Œçš„è·ç¦»æ•°æ®
                            let prevDistance = "N/A";
                            if (stopIndex > headerIndex + 1) {
                                const prevColumns = lines[stopIndex - 1].split('â”‡').map(c => c.trim());
                                if (prevColumns.length >= 2) {
                                    prevDistance = prevColumns[1];
                                }
                            }
                            
                            // æ›´æ–°æ˜¾ç¤º
                            document.getElementById('longitude-value').textContent = stopColumns[3] || '-';
                            document.getElementById('latitude-value').textContent = stopColumns[4] || '-';
                            document.getElementById('flight-time-value').textContent = stopColumns[11] || '-';
                            document.getElementById('prev-distance-value').textContent = prevDistance;
                        }
                    }
                 
                    // è®¡ç®—æœ€å¤§é«˜åº¦å’Œæœ€è¿œè·ç¦»ï¼ˆæ ¼å¼1å¸¦å•ä½Mï¼‰
                    let maxHeight = 0;
                    let maxDistance = 0;
                    
                    for (let i = headerIndex + 1; i < lines.length; i++) {
                        if (lines[i].trim() === '') continue;
                        
                        const columns = lines[i].split('â”‡').map(c => c.trim());
                        if (columns.length < 12) continue;
                        
                        // è§£æé«˜åº¦å€¼ï¼ˆå»æ‰å•ä½Mï¼‰
                        const heightStr = columns[2] || '0M';
                        const heightValue = parseFloat(heightStr.replace('M', '')) || 0;
                        
                        // è§£æè·ç¦»å€¼ï¼ˆå»æ‰å•ä½Mï¼‰
                        const distanceStr = columns[1] || '0M';
                        const distanceValue = parseFloat(distanceStr.replace('M', '')) || 0;
                        
                        if (heightValue > maxHeight) maxHeight = heightValue;
                        if (distanceValue > maxDistance) maxDistance = distanceValue;
                    }
                    
                    document.getElementById('max-height-value').textContent = maxHeight.toFixed(1) + 'M';
                    document.getElementById('max-distance-value').textContent = maxDistance.toFixed(1) + 'M';
                } else if (format === 'format2') {
                    // å¯¹äºç¬¬äºŒç§æ ¼å¼ï¼Œæ˜¾ç¤ºæœ€åä¸€æ¡è®°å½•çš„å…³é”®ä¿¡æ¯
                    if (lines.length > headerIndex + 1) {
                        const headers = lines[headerIndex].split(',').map(h => h.trim());
                        const lastLine = lines[lines.length - 1];
                        const columns = lastLine.split(',').map(c => c.trim());
                        
                        // ä½¿ç”¨é€šç”¨å‡½æ•°å¤„ç†æ ¼å¼2å’Œæ ¼å¼4çš„å…¬å…±é€»è¾‘
                        processCommonFormatData(headers, columns, lines, headerIndex, 'format2');
                    }
                } else if (format === 'format3') {
                    const headers = lines[headerIndex].split('â”‡').map(h => h.trim()).filter(h => h !== '');
                    
                    // æ‰¾åˆ°å…³é”®åˆ—çš„ç´¢å¼•
                    let timeIndex = -1, distIndex = -1, heightIndex = -1, 
                        lngIndex = -1, latIndex = -1;
                    
                    headers.forEach((header, index) => {
                        if (header === 'å½“å‰æ—¶é—´') timeIndex = index;
                        else if (header === 'è·ç¦»') distIndex = index;
                        else if (header === 'é«˜åº¦') heightIndex = index;
                        else if (header === 'ç»åº¦') lngIndex = index;
                        else if (header === 'çº¬åº¦') latIndex = index;
                    });
                    
                    // è®¡ç®—æœ€å¤§é«˜åº¦å’Œæœ€è¿œè·ç¦»
                    let maxHeight = 0;
                    let maxDistance = 0;
                    
                    for (let i = headerIndex + 1; i < lines.length; i++) {
                        if (lines[i].trim() === '') continue;
                        
                        const columns = lines[i].split('â”‡').map(c => c.trim()).filter(c => c !== '');
                        if (columns.length <= Math.max(heightIndex, distIndex)) continue;
                        
                        // è§£æé«˜åº¦å€¼ï¼ˆå»æ‰å•ä½Mï¼‰
                        const heightStr = columns[heightIndex] || '0.0M';
                        const heightValue = parseFloat(heightStr.replace('M', '')) || 0;
                        
                        // è§£æè·ç¦»å€¼ï¼ˆå»æ‰å•ä½Mï¼‰
                        const distanceStr = columns[distIndex] || '0.0M';
                        const distanceValue = parseFloat(distanceStr.replace('M', '')) || 0;
                        
                        // æ›´æ–°æœ€å¤§é«˜åº¦å’Œæœ€è¿œè·ç¦»
                        if (heightValue > maxHeight) maxHeight = heightValue;
                        if (distanceValue > maxDistance) maxDistance = distanceValue;
                    }
                    
                    // é£è¡Œæ—¶é—´è®¡ç®—å·²ç”±ç»Ÿä¸€çš„calculateFlightTimeå‡½æ•°å¤„ç†
                    let flightDuration = calculateFlightTime(lines, headerIndex, format, cumulativeFlightTimeIndex);
                    let useLastLineForCoordinates = flightDuration === "00:00:00";
                    
                    // è·å–æœ€åçŠ¶æ€çš„æ•°æ®
                    let lastColumns = [];
                    let flightEndIndex = lines.length - 1;
                    
                    // ä»æœ«å°¾å‘å‰æŸ¥æ‰¾æœ€åä¸€æ¬¡é£è¡Œè®°å½•
                    for (let i = lines.length - 1; i > headerIndex; i--) {
                        if (lines[i].trim() === '') continue;
                        
                        const columns = lines[i].split('â”‡').map(c => c.trim()).filter(c => c !== '');
                        if (columns.length <= Math.max(heightIndex)) continue;
                        
                        // è§£æé«˜åº¦å€¼ï¼ˆå»æ‰å•ä½Mï¼‰
                        const heightStr = columns[heightIndex] || '0.0M';
                        const heightValue = parseFloat(heightStr.replace('M', '')) || 0;
                        
                        // å¦‚æœé£è¡Œæ—¶é—´ä¸º00:00:00ï¼Œç›´æ¥ä½¿ç”¨æœ€åä¸€è¡Œ
                        if (useLastLineForCoordinates) {
                            flightEndIndex = i;
                            break;
                        }
                        
                        if (heightValue > 0) {
                            flightEndIndex = i;
                            break;
                        }
                    }
                    
                    if (flightEndIndex !== -1) {
                        lastColumns = lines[flightEndIndex].split('â”‡').map(c => c.trim()).filter(c => c !== '');
                    }
                    
                    // è·å–ä¸Šä¸€è¡Œçš„è·ç¦»æ•°æ®
                    let prevDistance = "N/A";
                    if (flightEndIndex > headerIndex + 1) {
                        const prevLine = lines[flightEndIndex - 1];
                        if (prevLine && prevLine.trim() !== '') {
                            const prevColumns = prevLine.split('â”‡').map(c => c.trim()).filter(c => c !== '');
                            if (distIndex !== -1 && prevColumns[distIndex]) {
                                prevDistance = prevColumns[distIndex];
                            }
                        }
                    }
                    
                    // æ›´æ–°æ˜¾ç¤º
                    document.getElementById('longitude-value').textContent = 
                        lngIndex !== -1 && lastColumns[lngIndex] ? lastColumns[lngIndex] : '-';
                    document.getElementById('latitude-value').textContent = 
                        latIndex !== -1 && lastColumns[latIndex] ? lastColumns[latIndex] : '-';
                    document.getElementById('flight-time-value').textContent = flightDuration;
                    document.getElementById('prev-distance-value').textContent = prevDistance;
                    document.getElementById('max-height-value').textContent = maxHeight.toFixed(1) + 'M';
                    document.getElementById('max-distance-value').textContent = maxDistance.toFixed(1) + 'M';
                } else if (format === 'format4') {
                    // å¯¹äºç¬¬å››ç§æ ¼å¼ï¼Œæ˜¾ç¤ºæœ€åä¸€æ¡è®°å½•çš„å…³é”®ä¿¡æ¯
                    if (lines.length > headerIndex + 1) {
                        const headers = lines[headerIndex].split(',').map(h => h.trim());
                        const lastLine = lines[lines.length - 1];
                        const columns = lastLine.split(',').map(c => c.trim());
                        
                        // ä½¿ç”¨é€šç”¨å‡½æ•°å¤„ç†æ ¼å¼2å’Œæ ¼å¼4çš„å…¬å…±é€»è¾‘
                        processCommonFormatData(headers, columns, lines, headerIndex, 'format4');
                    }
                }
                    // åœ¨å‡½æ•°çš„æœ€åæ·»åŠ ä»¥ä¸‹ä»£ç ï¼š
    
    // è‡ªåŠ¨æŸ¥è¯¢æµ·æ‹”é«˜åº¦ï¼ˆåªæœ‰åœ¨æœ‰æœ‰æ•ˆåæ ‡æ—¶ï¼‰
    const longitudeText = document.getElementById('longitude-value').textContent;
    const latitudeText = document.getElementById('latitude-value').textContent;
    
    if (longitudeText !== '-' && latitudeText !== '-' && 
        longitudeText !== '' && latitudeText !== '') {
        // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMæ›´æ–°å®Œæˆ
        setTimeout(() => {
            queryElevation();
        }, 500);
    }
            }
            
            // è®¡ç®—é£è¡Œæ—¶é—´ï¼ˆé‡æ„åçš„é€»è¾‘ï¼‰
            function calculateFlightTime(lines, headerIndex, format, cumulativeFlightTimeIndex = -1) {


                
                if (lines.length < headerIndex + 2) return '00:00:00';
                
                // å¯¹äºæ‰€æœ‰æ ¼å¼ï¼Œé¦–å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨"ç´¯è®¡é£è¡Œ"å­—æ®µ
                let hasCumulativeFlightTime = false;
                let maxCumulativeTime = 0;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ç´¯è®¡é£è¡Œæ—¶é—´åˆ—
                if (cumulativeFlightTimeIndex !== -1) {
                    hasCumulativeFlightTime = true;

                    
                    // éå†æ‰€æœ‰æ•°æ®è¡Œï¼Œæ‰¾åˆ°ç´¯è®¡é£è¡Œæ—¶é—´çš„æœ€å¤§å€¼
                    for (let i = headerIndex + 1; i < lines.length; i++) {
                        if (lines[i].trim() === '') continue;
                        
                        let columns;
                        if (format === 'format3') {
                            columns = lines[i].split('â”‡').map(c => c.trim()).filter(c => c !== '');
                        } else {
                            columns = lines[i].split(',').map(c => c.trim());
                        }
                        
                        if (columns.length <= cumulativeFlightTimeIndex) continue;
                        
                        const timeStr = columns[cumulativeFlightTimeIndex] || '00:00:00';
                        // è§£æHH:MM:SSæ ¼å¼çš„æ—¶é—´
                        let timeValue = 0;
                        if (timeStr.includes(':')) {
                            const timeParts = timeStr.split(':');
                            if (timeParts.length === 3) {
                                timeValue = parseInt(timeParts[0]) * 3600 + 
                                           parseInt(timeParts[1]) * 60 + 
                                           parseInt(timeParts[2]);
                            }
                        } else {
                            timeValue = parseFloat(timeStr) || 0;
                        }

                        
                        if (timeValue > maxCumulativeTime) {
                            maxCumulativeTime = timeValue;
                        }
                    }
                } else {
                }
                
                // å¦‚æœå­˜åœ¨ç´¯è®¡é£è¡Œå­—æ®µä¸”æœ€å¤§å€¼å¤§äº0ï¼Œä½¿ç”¨ç´¯è®¡é£è¡Œæ—¶é—´
                if (hasCumulativeFlightTime && maxCumulativeTime > 0) {
                    const hours = Math.floor(maxCumulativeTime / 3600);
                    const minutes = Math.floor((maxCumulativeTime % 3600) / 60);
                    const seconds = Math.floor(maxCumulativeTime % 60);
                    const result = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    return result;
                }
                
                // å¦‚æœæ²¡æœ‰ç´¯è®¡é£è¡Œå­—æ®µï¼Œä»æ—¶é—´æˆ³å­—æ®µè®¡ç®—ç¬¬ä¸€æ¡å’Œæœ€åä¸€æ¡è®°å½•çš„æ—¶é—´å·®
                let timeIndex = -1;
                let headers;
                
                // è·å–è¡¨å¤´
                if (format === 'format3') {
                    headers = lines[headerIndex].split('â”‡').map(h => h.trim()).filter(h => h !== '');
                } else {
                    headers = lines[headerIndex].split(',').map(h => h.trim());
                }

                
                // æŸ¥æ‰¾æ—¶é—´æˆ³å­—æ®µ
                headers.forEach((header, index) => {
                    if (header.includes('æ—¶é—´') || header.includes('Time') || header.includes('UTC') || 
                        header === 'å½“å‰æ—¶é—´' || header === 'timestamp') {
                        timeIndex = index;

                    }
                });
                
                if (timeIndex === -1) {
                    return '00:00:00';
                }
                
                // è·å–ç¬¬ä¸€æ¡è®°å½•çš„æ—¶é—´
                let firstTime = null;
                for (let i = headerIndex + 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    let columns;
                    if (format === 'format3') {
                        columns = lines[i].split('â”‡').map(c => c.trim()).filter(c => c !== '');
                    } else {
                        columns = lines[i].split(',').map(c => c.trim());
                    }
                    
                    if (columns.length <= timeIndex) continue;
                    
                    const timeStr = columns[timeIndex];
                    
                    // è‡ªå®šä¹‰æ—¶é—´æˆ³è§£æé€»è¾‘
                    let currentTime = null;
                    
                    // å¤„ç†çº¯æ•°å­—æ—¶é—´æˆ³ï¼ˆç§’æˆ–æ¯«ç§’ï¼‰
                    if (/^\d+$/.test(timeStr)) {
                        const timestamp = parseInt(timeStr);
                        // åˆ¤æ–­æ˜¯ç§’è¿˜æ˜¯æ¯«ç§’ï¼ˆå¦‚æœæ•°å­—å°äº10000000000ï¼Œè®¤ä¸ºæ˜¯ç§’ï¼Œéœ€è¦è½¬æ¢ä¸ºæ¯«ç§’ï¼‰
                        if (timestamp < 10000000000) {
                            currentTime = new Date(timestamp * 1000);
                        } else {
                            currentTime = new Date(timestamp);
                        }
                    } else {
                        // å°è¯•æ ‡å‡†æ—¥æœŸæ ¼å¼è§£æ
                        try {
                            currentTime = new Date(timeStr);
                        } catch (e) {
                            continue; // è·³è¿‡æ— æ³•è§£æçš„æ—¶é—´æˆ³
                        }
                    }
                    
                    if (currentTime) {
                        firstTime = currentTime;
                        break;
                    }
                }
                
                // è·å–æœ€åä¸€æ¡è®°å½•çš„æ—¶é—´
                let lastTime = null;
                for (let i = lines.length - 1; i > headerIndex; i--) {
                    if (lines[i].trim() === '') continue;
                    
                    let columns;
                    if (format === 'format3') {
                        columns = lines[i].split('â”‡').map(c => c.trim()).filter(c => c !== '');
                    } else {
                        columns = lines[i].split(',').map(c => c.trim());
                    }
                    
                    if (columns.length <= timeIndex) continue;
                    
                    const timeStr = columns[timeIndex];
                    
                    // è‡ªå®šä¹‰æ—¶é—´æˆ³è§£æé€»è¾‘
                    let currentTime = null;
                    
                    // å¤„ç†çº¯æ•°å­—æ—¶é—´æˆ³ï¼ˆç§’æˆ–æ¯«ç§’ï¼‰
                    if (/^\d+$/.test(timeStr)) {
                        const timestamp = parseInt(timeStr);
                        // åˆ¤æ–­æ˜¯ç§’è¿˜æ˜¯æ¯«ç§’ï¼ˆå¦‚æœæ•°å­—å°äº10000000000ï¼Œè®¤ä¸ºæ˜¯ç§’ï¼Œéœ€è¦è½¬æ¢ä¸ºæ¯«ç§’ï¼‰
                        if (timestamp < 10000000000) {
                            currentTime = new Date(timestamp * 1000);
                        } else {
                            currentTime = new Date(timestamp);
                        }
                    } else {
                        // å°è¯•æ ‡å‡†æ—¥æœŸæ ¼å¼è§£æ
                        try {
                            currentTime = new Date(timeStr);
                        } catch (e) {
                            continue; // è·³è¿‡æ— æ³•è§£æçš„æ—¶é—´æˆ³
                        }
                    }
                    
                    if (currentTime) {
                        lastTime = currentTime;
                        break;
                    }
                }
                
                if (!firstTime || !lastTime) {
                    return '00:00:00';
                }
                
                // è®¡ç®—æ—¶é—´å·®ï¼ˆæœ€åä¸€æ¡è®°å½•å‡å»ç¬¬ä¸€æ¡è®°å½•ï¼‰
                const totalTimeMs = Math.abs(lastTime - firstTime);
                
                // è½¬æ¢ä¸ºæ—¶åˆ†ç§’æ ¼å¼
                const hours = Math.floor(totalTimeMs / (1000 * 60 * 60));
                const minutes = Math.floor((totalTimeMs % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((totalTimeMs % (1000 * 60)) / 1000);
                const result = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                return result;
            }
            
            // é€šç”¨å‡½æ•°å¤„ç†æ ¼å¼2å’Œæ ¼å¼4çš„å…¬å…±é€»è¾‘
            function processCommonFormatData(headers, columns, lines, headerIndex, formatType) {
                // å°è¯•æ‰¾åˆ°å…³é”®æ•°æ®çš„åˆ—ç´¢å¼•
                let latIndex = -1, lngIndex = -1, timeIndex = -1, distIndex = -1, statusIndex = -1;
                let heightIndex = -1, distanceIndex = -1;
                
                headers.forEach((header, index) => {
                    if (formatType === 'format2') {
                        if (header === 'çº¬åº¦') latIndex = index;
                        else if (header === 'ç»åº¦') lngIndex = index;
                        else if (header === 'UTCæ—¶é—´') timeIndex = index;
                        else if (header === 'é£è¡Œè·ç¦»') distIndex = index;
                        else if (header === 'é£è¡ŒçŠ¶æ€') statusIndex = index;
                        else if (header === 'é£è¡Œé«˜åº¦') heightIndex = index;
                        else if (header === 'é£è¡Œè·ç¦»') distanceIndex = index;
                    } else if (formatType === 'format4') {
                        if (header === 'lat') latIndex = index;
                        else if (header === 'lon') lngIndex = index;
                        else if (header === 'UTC') timeIndex = index;
                        else if (header === 'distance') distIndex = index;
                        else if (header === 'AutoTakeOFF') statusIndex = index;
                        else if (header === 'height') heightIndex = index;
                        else if (header === 'distance') distanceIndex = index;
                    }
                });
                
                // æ›´æ–°æ˜¾ç¤º
                document.getElementById('longitude-value').textContent = 
                    lngIndex !== -1 && columns[lngIndex] ? columns[lngIndex] : '-';
                document.getElementById('latitude-value').textContent = 
                    latIndex !== -1 && columns[latIndex] ? columns[latIndex] : '-';
      
                // è·å–ä¸Šä¸€è¡Œçš„è·ç¦»æ•°æ®
                let prevDistance = "N/A";
                if (lines.length > headerIndex + 2) {
                    const prevColumns = lines[lines.length - 2].split(',').map(c => c.trim());
                    if (distIndex !== -1 && prevColumns[distIndex]) {
                        prevDistance = prevColumns[distIndex];
                    }
                }
                
                document.getElementById('prev-distance-value').textContent = prevDistance;
                
                // è®¡ç®—é£è¡Œæ—¶é—´ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„calculateFlightTimeå‡½æ•°ï¼‰
                let cumulativeFlightTimeIndex = -1;
                headers.forEach((header, index) => {
                    if (header === 'ç´¯è®¡é£è¡Œ' || header === 'ç´¯è®¡é£è¡Œæ—¶é—´') {
                        cumulativeFlightTimeIndex = index;
                    }
                });
                
                const flightDuration = calculateFlightTime(lines, headerIndex, formatType, cumulativeFlightTimeIndex);
                document.getElementById('flight-time-value').textContent = flightDuration;
                
                // è®¡ç®—æœ€å¤§é«˜åº¦å’Œæœ€è¿œè·ç¦»
                let maxHeight = 0;
                let maxDistance = 0;
                
                for (let i = headerIndex + 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    const rowColumns = lines[i].split(',').map(c => c.trim());
                    
                    // è§£æé«˜åº¦å€¼
                    if (heightIndex !== -1 && rowColumns[heightIndex]) {
                        const heightValue = parseFloat(rowColumns[heightIndex]) || 0;
                        if (heightValue > maxHeight) maxHeight = heightValue;
                    }
                    
                    // è§£æè·ç¦»å€¼
                    if (distanceIndex !== -1 && rowColumns[distanceIndex]) {
                        const distanceValue = parseFloat(rowColumns[distanceIndex]) || 0;
                        if (distanceValue > maxDistance) maxDistance = distanceValue;
                    }
                }
                
                document.getElementById('max-height-value').textContent = maxHeight.toFixed(1);
                document.getElementById('max-distance-value').textContent = maxDistance.toFixed(1);
            }
        });

        // æŸ¥è¯¢æµ·æ‹”é«˜åº¦çš„å‡½æ•°ï¼ˆä½¿ç”¨å…¨å±€åæ ‡è½¬æ¢ï¼‰
        async function queryElevation() {
            try {
                // è·å–ç¬¬ä¸€æ¡ç»çº¬åº¦æ•°æ®
                const longitudeText = document.getElementById('longitude-value').textContent;
                const latitudeText = document.getElementById('latitude-value').textContent;
                
                const coords = formatAndConvertCoordinates(longitudeText, latitudeText);
                if (!coords) {
                    showToast('è¯·å…ˆåŠ è½½æ—¥å¿—æ–‡ä»¶è·å–æœ‰æ•ˆåæ ‡æ•°æ®');
                    return;
                }
                
                const { convertedLat, convertedLng } = coords;
                
                //showToast('æ­£åœ¨æŸ¥è¯¢æµ·æ‹”é«˜åº¦...');
                
                // ä½¿ç”¨Open-Elevation APIæŸ¥è¯¢æµ·æ‹”
                const url = `https://api.open-elevation.com/api/v1/lookup?locations=${convertedLat},${convertedLng}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const elevation = Math.round(data.results[0].elevation);
                    document.getElementById('StartHaiBa').value = elevation;
                    //showToast(`æµ·æ‹”æŸ¥è¯¢æˆåŠŸ: ${elevation}ç±³`);
                } else {
                    showToast('æµ·æ‹”æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
                
            } catch (error) {
                console.error('æŸ¥è¯¢æµ·æ‹”å¤±è´¥:', error);
                showToast('æŸ¥è¯¢æµ·æ‹”å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // ç»‘å®šæŸ¥è¯¢æµ·æ‹”æŒ‰é’®äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const queryBtn = document.getElementById('query-elevation-btn');
            if (queryBtn) {
                queryBtn.addEventListener('click', queryElevation);
            }
        });

        // ===== ç»„åˆåŠŸèƒ½ç›¸å…³ä»£ç  =====
        
        let currentFormatType = null;
        let selectedCombination = [];
        
        // åˆå§‹åŒ–ç»„åˆåŠŸèƒ½
        function initCombinationFeature() {
            const combineBtn = document.getElementById('combine-data-btn');
            const saveBtn = document.getElementById('save-combination-btn');
            const cancelBtn = document.getElementById('cancel-combine-btn');
            const manageBtn = document.getElementById('manage-combinations-btn');
            const closeManagerBtn = document.getElementById('close-manager-btn');
            
            if (combineBtn) {
                combineBtn.addEventListener('click', toggleCombineMode);
            }
            if (saveBtn) {
                saveBtn.addEventListener('click', saveCombination);
            }
            if (cancelBtn) {
                cancelBtn.addEventListener('click', cancelCombineMode);
            }
            if (manageBtn) {
                manageBtn.addEventListener('click', openCombinationManager);
            }
            if (closeManagerBtn) {
                closeManagerBtn.addEventListener('click', closeCombinationManager);
            }
            
            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            document.getElementById('combination-manager').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeCombinationManager();
                }
            });
        }
        
        // åˆ‡æ¢ç»„åˆæ¨¡å¼
        function toggleCombineMode() {
            const combineDataBtn = document.getElementById('combine-data-btn');
            combineDataBtn.classList.add('active');
            combineDataBtn.style.backgroundColor = '#8593ab';
            const selectionArea = document.getElementById('combine-selection-area');
            const isVisible = selectionArea.style.display !== 'none';
            
            if (isVisible) {
                cancelCombineMode();
            } else {
                showCombineSelection();
            }
        }
        
        // æ˜¾ç¤ºç»„åˆé€‰æ‹©åŒºåŸŸ
        function showCombineSelection() {
            const selectionArea = document.getElementById('combine-selection-area');
            const checkboxesContainer = document.getElementById('combine-checkboxes');
            
            if (!selectionArea || !checkboxesContainer) return;
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            checkboxesContainer.innerHTML = '';
            selectedCombination = [];
            
            // è·å–æ‰€æœ‰å¯ç”¨çš„æ•°æ®é¡¹
            const availableFields = Object.keys(chartData.datasets).filter(field => 
                shouldShowInChart(field) && 
                chartData.datasets[field] && 
                chartData.datasets[field].length > 0
            );
            
            if (availableFields.length === 0) {
                showToast('å½“å‰æ²¡æœ‰å¯ç”¨çš„æ•°æ®é¡¹');
                return;
            }
            
            // åˆ›å»ºå¤é€‰æ¡†
            availableFields.forEach(field => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'combine-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `combine-${field}`;
                checkbox.value = field;
                checkbox.addEventListener('change', updateCombineInfo);
                
                const label = document.createElement('label');
                label.htmlFor = `combine-${field}`;
                label.textContent = getFieldLabel(field);
                
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                checkboxesContainer.appendChild(checkboxDiv);
            });
            
            selectionArea.style.display = 'block';
            updateCombineInfo();
        }
        
        // æ›´æ–°ç»„åˆä¿¡æ¯
        function updateCombineInfo() {
            const checkboxes = document.querySelectorAll('#combine-checkboxes input[type="checkbox"]:checked');
            const infoSpan = document.getElementById('combine-info');
            const saveBtn = document.getElementById('save-combination-btn');
            
            selectedCombination = Array.from(checkboxes).map(cb => cb.value);
            
            if (infoSpan) {
                infoSpan.textContent = `å·²é€‰æ‹© ${selectedCombination.length} ä¸ªæ•°æ®é¡¹`;
                infoSpan.style.color = selectedCombination.length >= 2 ? '#4caf50' : '#666';
            }
            
            if (saveBtn) {
                saveBtn.disabled = selectedCombination.length < 2;
                saveBtn.style.opacity = selectedCombination.length < 2 ? '0.5' : '1';
            }
        }
        
        // å–æ¶ˆç»„åˆæ¨¡å¼
        function cancelCombineMode() {
            const selectionArea = document.getElementById('combine-selection-area');
            if (selectionArea) {
                selectionArea.style.display = 'none';
            }
            selectedCombination = [];
        }
        
        // ä¿å­˜ç»„åˆ
        function saveCombination() {
            if (selectedCombination.length < 2) {
                showToast('è¯·è‡³å°‘é€‰æ‹©2ä¸ªæ•°æ®é¡¹');
                return;
            }
            
            const combinationName = selectedCombination.map(field => getFieldLabel(field)).join(' + ');
            const combination = {
                name: combinationName,
                fields: selectedCombination,
                formatType: currentFormatType,
                timestamp: new Date().toISOString()
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveCombinationToStorage(combination);
            
            // æ›´æ–°æ˜¾ç¤º
            loadSavedCombinations();
            cancelCombineMode();
            showToast(`ç»„åˆã€Œ${combinationName}ã€å·²ä¿å­˜`);
        }
        
        // ä¿å­˜ç»„åˆåˆ°æœ¬åœ°å­˜å‚¨
        function saveCombinationToStorage(combination) {
            const key = 'drone_combinations';
            let combinations = JSON.parse(localStorage.getItem(key) || '[]');
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒåç§°çš„ç»„åˆ
            const existingIndex = combinations.findIndex(c => c.name === combination.name);
            if (existingIndex !== -1) {
                combinations[existingIndex] = combination;
            } else {
                combinations.push(combination);
            }
            
            localStorage.setItem(key, JSON.stringify(combinations));
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç»„åˆ
        function loadCombinationsFromStorage() {
            const key = 'drone_combinations';
            return JSON.parse(localStorage.getItem(key) || '[]');
        }
        
        // åŠ è½½å¹¶æ˜¾ç¤ºå·²ä¿å­˜çš„ç»„åˆ
        function loadSavedCombinations() {
            const container = document.getElementById('saved-combinations');
            if (!container) return;
            
            const combinations = loadCombinationsFromStorage();
            container.innerHTML = '';
            
            // ç­›é€‰å½“å‰æ ¼å¼ç±»å‹çš„ç»„åˆ
            const validCombinations = combinations.filter(c => c.formatType === currentFormatType);
            
            if (validCombinations.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            validCombinations.forEach(combination => {
                const button = createCombinationButton(combination);
                container.appendChild(button);
            });
            
            container.style.display = 'flex';
        }
        
        // åˆ›å»ºç»„åˆæŒ‰é’®
        function createCombinationButton(combination) {
            const button = document.createElement('button');
            button.className = 'saved-combination-btn';
            button.textContent = combination.name;
            button.title = combination.fields.map(f => getFieldLabel(f)).join(' + ');
            
            button.addEventListener('click', () => displayCombination(combination));
            
            return button;
        }
        
        // æ˜¾ç¤ºç»„åˆæ•°æ®
        function displayCombination(combination) {
            if (!dataChart) {
                showToast('å›¾è¡¨å°šæœªåˆå§‹åŒ–');
                return;
            }
            
            // æ£€æŸ¥æ‰€æœ‰å­—æ®µæ˜¯å¦éƒ½å­˜åœ¨
            const missingFields = combination.fields.filter(field => 
                !chartData.datasets[field] || chartData.datasets[field].length === 0
            );
            
            if (missingFields.length > 0) {
                showToast(`ç»„åˆä¸­åŒ…å«å·²åˆ é™¤çš„æ•°æ®é¡¹ï¼Œæ­£åœ¨æ›´æ–°...`);
                removeInvalidCombinations();
                loadSavedCombinations();
                return;
            }
            
            // é‡ç½®æ‰€æœ‰æŒ‰é’®æ ·å¼
            const chartButtons = document.querySelectorAll('.chart-btn');
            chartButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.backgroundColor = '';
            });
            
            // é‡ç½®å…¶ä»–ç»„åˆæŒ‰é’®æ ·å¼ï¼Œç„¶åæ¿€æ´»å½“å‰æŒ‰é’®
            resetCombinationButtons();
            const combinationButtons = document.querySelectorAll('.saved-combination-btn');
            combinationButtons.forEach(btn => {
                if (btn.textContent === combination.name) {
                    btn.classList.add('active');
                }
            });
            
            // åˆ›å»ºç»„åˆæ•°æ®é›†
            const datasets = [];
            const MAX_POINTS_PER_DATASET = 1000;
            
            combination.fields.forEach(field => {
                if (chartData.datasets[field] && chartData.datasets[field].length > 0) {
                    const originalData = chartData.datasets[field];
                    const sampledData = downsampleData(originalData, MAX_POINTS_PER_DATASET);
                    
                    const dataset = {
                        label: getFieldLabel(field),
                        data: sampledData,
                        borderColor: getFieldColor(field),
                        backgroundColor: getFieldColor(field) + '20',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 3
                    };
                    datasets.push(dataset);
                }
            });
            
            if (datasets.length === 0) {
                showToast('æ²¡æœ‰å¯ç”¨çš„æ•°æ®');
                return;
            }
            
            // æ ‡ç­¾é™é‡‡æ ·
            const labelStep = Math.ceil(chartData.labels.length / MAX_POINTS_PER_DATASET);
            const sampledLabels = [];
            for (let i = 0; i < chartData.labels.length; i += labelStep) {
                sampledLabels.push(chartData.labels[i]);
            }
            
            dataChart.options.animation = false;
            dataChart.data = {
                labels: sampledLabels,
                datasets: datasets
            };
            
            dataChart.update('none');
            
            if (dataChart.resetZoom) {
                dataChart.resetZoom();
            }
        }
        
        // ç§»é™¤æ— æ•ˆçš„ç»„åˆï¼ˆåŒ…å«å·²åˆ é™¤å­—æ®µçš„ç»„åˆï¼‰
        function removeInvalidCombinations() {
            const combinations = loadCombinationsFromStorage();
            const validCombinations = combinations.filter(combination => {
                return combination.fields.every(field => 
                    chartData.datasets[field] && chartData.datasets[field].length > 0
                );
            });
            
            localStorage.setItem('drone_combinations', JSON.stringify(validCombinations));
        }
        
        // æ‰“å¼€ç»„åˆç®¡ç†å™¨
        function openCombinationManager() {
            const manager = document.getElementById('combination-manager');
            const listContainer = document.getElementById('combination-list');
            const managerTitle = document.querySelector('#combination-manager h3');
            
            if (!manager || !listContainer) return;
            
            // è·å–å½“å‰è¡¨ç±»å‹çš„ä¸­æ–‡åç§°
            const formatTypeNames = {
                'format1': 'æ ¼å¼1',
                'format2': 'æ ¼å¼2',
                'format3': 'æ ¼å¼3',
                'format4': 'æ ¼å¼4'
            };
            const formatName = formatTypeNames[currentFormatType] || currentFormatType || 'æœªçŸ¥æ ¼å¼';
            
            // æ›´æ–°æ ‡é¢˜æ˜¾ç¤ºè¡¨ç±»å‹
            if (managerTitle) {
                managerTitle.innerHTML = `ç®¡ç†å·²ä¿å­˜çš„ç»„åˆé›† <small style="color: #ff9800; font-size: 0.8em;">(${formatName})</small>`;
            }
            
            const combinations = loadCombinationsFromStorage();
            const validCombinations = combinations.filter(c => c.formatType === currentFormatType);
            
            listContainer.innerHTML = '';
            
            if (validCombinations.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— å·²ä¿å­˜çš„ç»„åˆé›†</p>';
            } else {
                validCombinations.forEach((combination, index) => {
                    const item = document.createElement('div');
                    item.className = 'combination-item';
                    item.innerHTML = `
                        <div>
                            <strong>${combination.name}</strong>
                        </div>
                        <button class="combination-delete-btn" onclick="deleteCombination('${combination.name}')" title="åˆ é™¤">Ã—</button>
                    `;
                    listContainer.appendChild(item);
                });
            }
            
            manager.style.display = 'flex';
        }
        
        // å…³é—­ç»„åˆç®¡ç†å™¨
        function closeCombinationManager() {
            const manager = document.getElementById('combination-manager');
            if (manager) {
                manager.style.display = 'none';
            }
        }
        
        // åˆ é™¤ç»„åˆ
        function deleteCombination(name) {
            const combinations = loadCombinationsFromStorage();
            const filtered = combinations.filter(c => c.name !== name);
            localStorage.setItem('drone_combinations', JSON.stringify(filtered));
            
            loadSavedCombinations();
            openCombinationManager(); // åˆ·æ–°ç®¡ç†å™¨
            showToast(`ç»„åˆã€Œ${name}ã€å·²åˆ é™¤`);
        }
        
        // ä¿®æ”¹åŸæœ‰çš„processChartDataå‡½æ•°ï¼Œæ·»åŠ æ ¼å¼ç±»å‹è®°å½•
        const originalProcessChartData = processChartData;
        processChartData = function(lines, formatType) {
            currentFormatType = formatType;
            originalProcessChartData(lines, formatType);
            loadSavedCombinations();
        };
        
        // é‡ç½®æ‰€æœ‰ç»„åˆæŒ‰é’®æ ·å¼
        function resetCombinationButtons() {
            const combinationButtons = document.querySelectorAll('.saved-combination-btn');
            combinationButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '';
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç»„åˆåŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            initCombinationFeature();
        });
    </script>
</body>
</html>
